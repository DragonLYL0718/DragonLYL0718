---
layout: page
---

<script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<div class="tab-container">
    <div class="tab-nav">
        <button class="tab-btn active" data-year="All" onclick="GalleryPage.openYear(event, 'All')">All</button>

        {% assign raw_years = site.galleries | map: "year" | uniq %}
        {% assign numeric_years = "" | split: "" %}
        {% assign string_years = "" | split: "" %}

        {% for y in raw_years %}
        {% assign y_num = y | plus: 0 %}
        {% if y_num > 0 %}
        {% assign numeric_years = numeric_years | push: y %}
        {% else %}
        {% assign string_years = string_years | push: y %}
        {% endif %}
        {% endfor %}

        {% assign numeric_years = numeric_years | sort | reverse %}
        {% assign string_years = string_years | sort %}

        {% assign sorted_years = numeric_years | concat: string_years %}

        <!-- 1. Calculate Dynamic Blocks for years > 2020 -->
        {% assign block_ids = "" %}
        {% for y in sorted_years %}
        {% assign y_num = y | plus: 0 %}
        {% if y_num > 2020 %}
        <!-- (y-1)/5 to get block index. e.g. 2021..2025 -> 404, 2026..2030 -> 405 -->
        {% assign bid = y_num | minus: 1 | divided_by: 5 %}
        {% assign block_ids = block_ids | append: "," | append: bid %}
        {% endif %}
        {% endfor %}

        {% assign unique_bids = block_ids | remove_first: "," | split: "," | uniq %}

        <!-- 2. Render Dynamic Dropdowns -->
        {% for bid in unique_bids %}
        {% assign current_block_years = "" | split: "" %}

        {% for y in sorted_years %}
        {% assign y_num = y | plus: 0 %}
        {% if y_num > 2020 %}
        {% assign this_bid = y_num | minus: 1 | divided_by: 5 | append: "" %}
        {% if this_bid == bid %}
        {% assign current_block_years = current_block_years | push: y %}
        {% endif %}
        {% endif %}
        {% endfor %}

        {% if current_block_years.size > 0 %}
        {% assign max_y = current_block_years.first %}
        {% assign min_y = current_block_years.last %}
        {% assign label = min_y | append: "-" | append: max_y %}
        {% if min_y == max_y %}
        {% assign label = min_y %}
        {% endif %}

        <div class="dropdown">
            {% assign year_list_str = current_block_years | join: "," %}
            <button class="tab-btn dropbtn" onclick="GalleryPage.openGroup(event, '{{ year_list_str }}')">{{ label
                }}</button>
            <div class="dropdown-content">
                {% for y in current_block_years %}
                <button class="tab-btn" onclick="GalleryPage.openYear(event, '{{ y }}')">{{ y }}</button>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endfor %}

        <!-- 3. Render 'Before 2021' Group for years <= 2020 -->
        {% assign group_older = "" | split: "" %}
        {% for y in sorted_years %}
        {% assign y_num = y | plus: 0 %}
        <!-- Check for string years (0) or years <= 2020 -->
        {% if y == "pre-2018" or y_num <= 2020 %} {% assign group_older=group_older | push: y %} {% endif %} {% endfor
            %} {% if group_older.size> 0 %}
            <div class="dropdown">
                {% assign year_list_older = group_older | join: "," %}
                <button class="tab-btn dropbtn" onclick="GalleryPage.openGroup(event, '{{ year_list_older }}')">Before
                    2021</button>
                <div class="dropdown-content">
                    {% for y in group_older %}
                    <button class="tab-btn" onclick="GalleryPage.openYear(event, '{{ y }}')">{{ y }}</button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <button class="tab-btn active-map" id="map-toggle-btn" onclick="GalleryPage.toggleMap(event)">Map</button>
    </div>

    <input type="text" id="searchInput" placeholder="Search for locations..." onkeyup="GalleryPage.filterGalleries()">

    <!-- Map Container moved outside tab content and visible by default -->
    <div id="Map" class="map-section" style="display: block; margin-bottom: 20px;">
        <div id="map-container" style="height: 400px; width: 100%;"></div>
    </div>

    <div id="gallery-content">
        {% for year in sorted_years %}
        <div id="{{ year }}" class="tab-content is-visible">
            <h2>{{ year }}</h2>
            <div class="gallery-grid">
                {% assign galleries_by_year = site.galleries | where: "year", year %}
                {% for gallery in galleries_by_year %}
                {% for item in gallery.items %}
                <div class="card">
                    <div class="image-overlay-container">
                        <a href="{{ item.url }}">
                            <img class="lozad" data-src="{{ item.image }}"
                                src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxIDEiPjwvc3ZnPg==" />
                            <div class="card-text">{{ item.title }}</div>
                        </a>
                    </div>
                </div>
                {% endfor %}
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div id="search-results" class="gallery-grid" style="display: none;"></div>
</div>

<script>
    /*
    ================================================================================
      Gallery Page Script (Refactored for Reliability)
      - Uses global namespace `window.GalleryPage` to persist across PJAX.
      - Uses inline `onclick` handlers to avoid event binding race conditions.
    ================================================================================
    */
    (function () {
        /* Create namespace if not exists */
        window.GalleryPage = window.GalleryPage || {};

        /* Data */
        const galleryData = {{ site.galleries | jsonify
    }};

    /* State */
    let map = null;
    let markerClusterGroup = null;
    let currentYear = 'All';
    let isMapVisible = true;

    /* Initialize Map */
    window.GalleryPage.initMap = function () {
        if (map) return; /* Already initialized */
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) return;

        map = L.map('map-container').setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 50,
            iconCreateFunction: function (cluster) {
                const count = cluster.getChildCount();
                let size = 30;
                if (count > 10) size = 40;
                if (count > 50) size = 50;

                return L.divIcon({
                    html: count,
                    className: 'custom-marker-icon',
                    iconSize: L.point(size, size),
                    iconAnchor: [size / 2, size / 2]
                });
            }
        });

        /* Initial population of markers */
        window.GalleryPage.updateMapMarkers(currentYear);
        map.addLayer(markerClusterGroup);
    };

    /* Update Markers based on Year or List of Years */
    window.GalleryPage.updateMapMarkers = function (yearOrList) {
        if (!markerClusterGroup) return;

        markerClusterGroup.clearLayers();

        // Convert input to array of strings for comparison
        const targetYears = yearOrList === 'All' ? ['All'] : yearOrList.split(',');

        galleryData.forEach(function (gallery) {
            /* Filter logic: if 'All', show everything. Else check if gallery.year is in targetYears */
            const gYear = String(gallery.year);
            if (targetYears[0] === 'All' || targetYears.includes(gYear)) {
                if (gallery.items) {
                    gallery.items.forEach(function (item) {
                        if (item.lat && item.lng) {
                            const customIcon = L.divIcon({
                                html: "1",
                                className: 'custom-marker-icon',
                                iconSize: L.point(30, 30),
                                iconAnchor: [15, 15]
                            });
                            const marker = L.marker([item.lat, item.lng], { icon: customIcon });
                            const popupContent =
                                '<div style="text-align:center;">' +
                                '<a href="' + item.url + '" style="text-decoration:none; color:inherit;">' +
                                '<img src="' + item.image + '" style="max-width:150px; border-radius:4px; display:block; margin-bottom:5px;" />' +
                                '<strong>' + item.title + '</strong>' +
                                '</a>' +
                                '</div>';
                            marker.bindPopup(popupContent);
                            markerClusterGroup.addLayer(marker);
                        }
                    });
                }
            }
        });
    };

    /* Toggle Map Visibility */
    window.GalleryPage.toggleMap = function (evt) {
        const mapDiv = document.getElementById("Map");
        const btn = document.getElementById("map-toggle-btn");

        isMapVisible = !isMapVisible;

        if (isMapVisible) {
            mapDiv.style.display = 'block';
            if (btn) {
                btn.classList.add('active-map');
                btn.classList.add('active');
            }

            /* Initialize if not already done */
            if (!map) {
                window.GalleryPage.initMap();
            } else {
                /* Ensure markers are correct for current selection when showing */
                window.GalleryPage.updateMapMarkers(currentYear);
            }

            setTimeout(function () { if (map) map.invalidateSize(); }, 100);
        } else {
            mapDiv.style.display = 'none';
            if (btn) {
                btn.classList.remove('active-map');
                btn.classList.remove('active');
            }
        }
    };

    /* Filter Function (Search Input) */
    window.GalleryPage.filterGalleries = function () {
        const searchInput = document.getElementById('searchInput');
        const galleryContent = document.getElementById('gallery-content');
        const searchResults = document.getElementById('search-results');

        if (!searchInput || !galleryContent || !searchResults) return;

        const filter = searchInput.value.toLowerCase();

        if (filter.length > 0) {
            galleryContent.style.display = 'none';
            searchResults.innerHTML = '';

            const allCards = galleryContent.querySelectorAll('.card');
            let matchesFound = false;

            allCards.forEach(function (card) {
                const title = card.querySelector('.card-text');
                if (title) {
                    const txtValue = title.textContent || title.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        searchResults.appendChild(card.cloneNode(true));
                        matchesFound = true;
                    }
                }
            });

            if (!matchesFound) {
                searchResults.innerHTML = '<p style="text-align: center; width: 100%;">No locations found.</p>';
            }
            searchResults.style.display = 'grid';
        } else {
            galleryContent.style.display = 'block';
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
        }
    };

    /* Tab Switching (Single Year) */
    window.GalleryPage.openYear = function (evt, yearName) {
        // reuse openGroup logic but for single item
        window.GalleryPage.openGroup(evt, yearName);
    };

    /* Tab Switching (Group or Single) */
    window.GalleryPage.openGroup = function (evt, yearListStr) {
        currentYear = yearListStr; // Store the list (e.g. "2021,2022")

        const tabContainer = document.querySelector('.tab-container');
        if (!tabContainer) return;

        // Hide all
        const tabcontent = tabContainer.getElementsByClassName("tab-content");
        for (let i = 0; i < tabcontent.length; i++) {
            tabcontent[i].classList.remove("is-visible");
            tabcontent[i].style.display = 'none';
        }

        // Deactivate all buttons
        const tablinks = tabContainer.getElementsByClassName("tab-btn");
        for (let i = 0; i < tablinks.length; i++) {
            if (!tablinks[i].classList.contains('active-map') && tablinks[i].id !== 'map-toggle-btn') {
                tablinks[i].classList.remove("active");
            }
        }

        // Add active class to clicked button
        // Note: For dropdown items, we might want to highlight the parent dropdown button too?
        // But for now, just the clicked element.
        if (evt && evt.target) {
            evt.target.classList.add("active");

            // If inside a dropdown, maybe highlight the dropbtn?
            const parentDropdown = evt.target.closest('.dropdown');
            if (parentDropdown) {
                const dropbtn = parentDropdown.querySelector('.dropbtn');
                if (dropbtn) dropbtn.classList.add('active');
            }
        }

        const searchInput = document.getElementById('searchInput');

        /* Handle Map Filter Updates */
        if (isMapVisible) {
            window.GalleryPage.updateMapMarkers(yearListStr);
        }

        /* Show Content */
        if (yearListStr === "All") {
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("is-visible");
                tabcontent[i].style.display = 'block';
            }
            if (searchInput) searchInput.style.display = 'block';
        } else {
            const targets = yearListStr.split(',');
            targets.forEach(function (y) {
                const targetElement = document.getElementById(y);
                if (targetElement) {
                    targetElement.classList.add("is-visible");
                    targetElement.style.display = 'block';
                }
            });
            if (searchInput) searchInput.style.display = 'block';
        }

        /* Reset Search when switching */
        if (searchInput) {
            searchInput.value = '';
            window.GalleryPage.filterGalleries();
        }
    };

    /* Initial setup on load */
    const init = function () {
        /* Need to set map button style initially */
        const mapBtn = document.getElementById('map-toggle-btn');
        if (mapBtn && isMapVisible) {
            mapBtn.classList.add('active-map');
            mapBtn.classList.add('active');
        }

        /* Initialize map immediately because it is visible by default */
        window.GalleryPage.initMap();

        /* Check active tab, default to All */
        const activeBtn = document.querySelector('.tab-btn.active');
        if (!activeBtn) {
            const allBtn = document.querySelector('.tab-btn[data-year="All"]');
            if (allBtn) window.GalleryPage.openYear({ target: allBtn }, 'All');
        }

        /* Initialize Lozad */
        if (typeof lozad !== 'undefined') {
            const observer = lozad('.lozad', {
                /* Load images 200px before they enter viewport */
                rootMargin: '200px',
                loaded: function (el) {
                    el.style.opacity = 1;
                }
            });
            observer.observe();
        }
    };

    /* Execute init immediately */
    init();

    /* Re-run init on PJAX completion (mostly for redundant safety) */
    window.addEventListener('hy:pjax:end', init);
            
    }) ();
</script>

<style>
    .lozad {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }
</style>

{{ content }}