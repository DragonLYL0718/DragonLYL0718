---
layout: pagegallery
---

<head>
    <link href="{{ '/assets/js/lightbox.css' | relative_url }}" rel="stylesheet" />
    <style>
        /* 基本样式 */
        .figure-grid {
            margin: 0 auto;
            /* Masonry JS 会负责定位 */
            opacity: 0;
            /* 初始隐藏，等待 JS 初始化后显示 */
            transition: opacity 0.5s ease-in-out;
        }

        .figure-grid.initialized {
            opacity: 1;
            /* 初始化后淡入 */
        }

        /* 用于 Masonry 计算列宽的 Sizer 元素 */
        .figure-grid-sizer {
            width: 33.333%;
        }

        @media screen and (max-width: 768px) {
            .figure-grid-sizer {
                width: 50%;
            }
        }

        @media screen and (max-width: 480px) {
            .figure-grid-sizer {
                width: 100%;
            }
        }

        /* 网格项样式 */
        .figure-grid-item {
            width: 33.333%;
            /* 设置左右内边距为 5px，上下为 0 */
            padding: 0 5px;
            box-sizing: border-box;
            /* 设置下方外边距为 10px */
            margin-bottom: 10px;
            float: left;
        }

        @media screen and (max-width: 768px) {
            .figure-grid-item {
                width: 50%;
            }
        }

        @media screen and (max-width: 480px) {
            .figure-grid-item {
                width: 100%;
            }
        }

        .figure-grid-item img {
            display: block;
            /* 移除图片下方的额外空间 */
            width: 100%;
            /* 使图片填充项 */
            height: auto;
            /* 保持宽高比 */
            background-color: #eee;
            /* 浅灰色占位背景 */
            min-height: 150px;
            /* 加载前的最小高度 */
            transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            /* 初始透明，为淡入效果准备 */
            border-radius: 4px;
            /* 轻微圆角 */
        }

        .figure-grid-item img.loaded {
            opacity: 1;
            /* 加载后淡入 */
            background-color: transparent;
            /* 移除占位背景 */
        }

        /* 图片呼吸/放大效果 */
        .figure-grid-item a:hover img {
            transform: scale(1.05);
            /* 悬停时放大图片 */
        }

        /* 确保链接没有下划线 */
        .figure-grid a,
        .figure-grid a:hover,
        .figure-grid a:visited {
            text-decoration: none;
            border: none;
            outline: none;
            display: block;
            /* 使链接容器成为块级元素 */
            background: none;
            /* 移除可能的背景 */
        }

        .figure-grid a::after {
            /* 移除主题可能添加的下划线 */
            content: none !important;
        }

        /* Lightbox 相关样式调整 (可选) */
        .lb-dataContainer {
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .lb-outerContainer {
            border-radius: 4px;
        }

        .lb-nav a.lb-prev,
        .lb-nav a.lb-next {
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .lb-nav a.lb-prev:hover,
        .lb-nav a.lb-next:hover {
            opacity: 1;
        }

        /* 清除浮动 */
        .figure-grid:after {
            content: '';
            display: block;
            clear: both;
        }
    </style>
</head>

<body>
    {{ content }}

    <script src="{{ '/assets/js/lozad.js' | relative_url }}"></script>
    <script src="{{ '/assets/js/masonry.pkgd.min.js' | relative_url }}"></script>
    <script src="{{ '/assets/js/imagesloaded.pkgd.min.js' | relative_url }}"></script>
    <script src="{{ '/assets/js/lightbox-plus-jquery.js' | relative_url }}"></script>

    <script>
        console.log("DEBUG: pagefigure.html script executing. Step 1: Script start.");

        // ---- State Setup ----
        console.log("DEBUG: Step 2: Setting up window.galleryState.");
        window.galleryState = window.galleryState || {};
        window.galleryState.msnryInstance = null;
        window.galleryState.isGalleryInitialized = false;
        window.galleryState.observer = null; // 用于存储 MutationObserver 实例
        console.log("DEBUG: Step 3: window.galleryState setup complete.");

        // ---- Function Definitions ----
        console.log("DEBUG: Step 4: Defining helper functions.");
        function checkLibraries() {
            console.log("DEBUG: Checking required libraries...");
            let allLoaded = true;
            if (typeof jQuery === 'undefined') { console.error('ERROR: jQuery library not loaded.'); allLoaded = false; }
            if (typeof Masonry === 'undefined') { console.error('ERROR: Masonry library not loaded.'); allLoaded = false; }
            if (typeof imagesLoaded === 'undefined') { console.error('ERROR: imagesLoaded library not loaded.'); allLoaded = false; }
            if (typeof lozad === 'undefined') { console.error('ERROR: lozad library not loaded.'); allLoaded = false; }
            if (typeof lightbox === 'undefined') { console.warn('WARN: lightbox library not loaded.'); }
            else { console.log("DEBUG: Lightbox library found."); }
            if (allLoaded) { console.log("DEBUG: All core libraries seem to be loaded."); }
            else { console.error("ERROR: One or more core libraries failed to load."); }
            return allLoaded;
        }

        function initializeGallery() {
            console.log(`DEBUG: Attempting to initialize gallery...`);
            const grid = document.querySelector('.figure-grid');

            if (!grid) {
                console.warn("DEBUG: '.figure-grid' element not found during initialization attempt. Will wait for MutationObserver.");
                return false; // Grid not ready
            }

            // Grid found, disconnect observer if it's running
            if (window.galleryState.observer) {
                console.log("DEBUG: Grid found, disconnecting MutationObserver.");
                window.galleryState.observer.disconnect();
                window.galleryState.observer = null;
            }

            // Check if already initialized (e.g., multiple triggers)
            if (window.galleryState.isGalleryInitialized) {
                console.log("DEBUG: Gallery already initialized. Skipping core logic, ensuring layout.");
                if (window.galleryState.msnryInstance) window.galleryState.msnryInstance.layout();
                return true;
            }

            if (!checkLibraries()) {
                return false; // Libraries not ready
            }

            // Cleanup potential old instance (just in case)
            if (window.galleryState.msnryInstance && typeof window.galleryState.msnryInstance.destroy === 'function') {
                console.log("DEBUG: Destroying previous Masonry instance.");
                try { window.galleryState.msnryInstance.destroy(); } catch (e) { console.warn("WARN: Error destroying previous instance:", e); }
                window.galleryState.msnryInstance = null;
            }

            console.log("DEBUG: Initializing Masonry...");
            try {
                window.galleryState.msnryInstance = new Masonry(grid, {
                    itemSelector: '.figure-grid-item',
                    columnWidth: '.figure-grid-sizer',
                    percentPosition: true,
                    gutter: 0
                });
                console.log("DEBUG: Masonry instance created.");
            } catch (error) {
                console.error("ERROR: Failed to initialize Masonry:", error);
                return false;
            }

            console.log("DEBUG: Initializing lozad...");
            const lozadObserver = lozad('.lozad', {
                rootMargin: '200px 0px',
                threshold: 0.1,
                loaded: function (el) {
                    // console.log(`DEBUG: Lozad loaded: ${el.dataset.src || el.src}`); // Optional: reduce log noise
                    el.classList.add('loaded');
                    imagesLoaded(el.closest('.figure-grid-item'), function () {
                        if (window.galleryState.msnryInstance) {
                            // console.log(`DEBUG: Image loaded & sized, relayout: ${el.dataset.src || el.src}`); // Optional: reduce log noise
                            window.galleryState.msnryInstance.layout();
                        } else { console.warn("WARN: Masonry instance gone when image loaded."); }
                    });
                }
            });
            lozadObserver.observe();
            console.log("DEBUG: Lozad observer started.");

            console.log("DEBUG: Setting up imagesLoaded for initial grid layout...");
            imagesLoaded(grid).on('always', function (instance) {
                console.log("DEBUG: imagesLoaded 'always'. Final layout check.");
                if (window.galleryState.msnryInstance) {
                    window.galleryState.msnryInstance.layout();
                    grid.classList.add('initialized');
                    console.log("DEBUG: Grid marked as initialized and visible.");
                }
            }).on('fail', function (instance) {
                console.warn(`WARN: imagesLoaded detected ${instance.images.length - instance.progressedCount} failed image(s).`);
                if (window.galleryState.msnryInstance) window.galleryState.msnryInstance.layout();
            });

            if (typeof lightbox !== 'undefined') {
                console.log("DEBUG: Initializing Lightbox2 options...");
                lightbox.option({
                    'resizeDuration': 200, 'wrapAround': true, 'fadeDuration': 300,
                    'imageFadeDuration': 300, 'fitImagesInViewport': true,
                    'disableScrolling': false, 'alwaysShowNavOnTouchDevices': true
                });
                console.log("DEBUG: Lightbox options set.");
            } else {
                console.warn("DEBUG: Lightbox library not found. Features disabled.");
            }

            window.galleryState.isGalleryInitialized = true;
            console.log("DEBUG: Gallery initialization sequence complete.");
            return true;
        }

        // Setup MutationObserver to watch for .figure-grid appearance
        function setupMutationObserver() {
            // Ensure we don't set up multiple observers
            if (window.galleryState.observer) {
                console.log("DEBUG: MutationObserver already exists. Skipping setup.");
                return;
            }
            // Check if grid already exists and initialize if so
            if (initializeGallery()) {
                console.log("DEBUG: Grid found immediately on observer setup. Initialization done.");
                return;
            }

            console.log("DEBUG: Setting up MutationObserver to watch for .figure-grid...");
            const targetNode = document.body; // Watch the whole body, or a more specific container if known
            const config = { childList: true, subtree: true };

            const callback = function (mutationsList, observer) {
                // Check if the grid now exists and hasn't been initialized
                if (document.querySelector('.figure-grid') && !window.galleryState.isGalleryInitialized) {
                    console.log("DEBUG: MutationObserver detected potential grid addition. Attempting initialization.");
                    initializeGallery();
                    // If initialization succeeded, the observer is disconnected inside initializeGallery
                }
            };

            window.galleryState.observer = new MutationObserver(callback);
            window.galleryState.observer.observe(targetNode, config);
            console.log("DEBUG: MutationObserver started.");
        }

        // Function to clean up on page transition (if possible)
        function cleanupGallery() {
            console.log("DEBUG: Cleaning up gallery state...");
            if (window.galleryState.observer) {
                console.log("DEBUG: Disconnecting MutationObserver during cleanup.");
                window.galleryState.observer.disconnect();
                window.galleryState.observer = null;
            }
            if (window.galleryState.msnryInstance && typeof window.galleryState.msnryInstance.destroy === 'function') {
                console.log("DEBUG: Destroying Masonry instance during cleanup.");
                try { window.galleryState.msnryInstance.destroy(); } catch (e) { console.warn("WARN: Error destroying Masonry instance during cleanup:", e); }
            }
            window.galleryState.msnryInstance = null;
            window.galleryState.isGalleryInitialized = false;
            // Note: We don't typically destroy lozad or imagesLoaded instances here
            console.log("DEBUG: Gallery cleanup complete.");
        }

        console.log("DEBUG: Step 5: Helper functions defined.");

        // ---- Initialization Logic ----
        console.log("DEBUG: Step 6: Starting initialization logic.");

        // Attempt immediate initialization or setup observer
        setupMutationObserver();
        console.log("DEBUG: Step 7: Initial setupMutationObserver call complete.");

        // Fallback for full page loads (Ctrl+R)
        // Using 'load' as DOMContentLoaded might fire before script execution in some edge cases
        window.addEventListener('load', () => {
            console.log("########## DEBUG: WINDOW.LOAD CALLBACK FIRED! ##########");
            // Only initialize if the observer hasn't already succeeded
            if (!window.galleryState.isGalleryInitialized) {
                console.warn("WARN: Gallery not initialized before window.load. Attempting via load event.");
                if (!initializeGallery()) {
                    console.error("ERROR: Initialization failed even on window.load.");
                    // If it failed here, maybe start the observer again?
                    // setupMutationObserver();
                } else if (window.galleryState.msnryInstance) {
                    // Ensure layout after load event initialization
                    console.log("DEBUG: Performing final layout check after load event init.");
                    setTimeout(() => { if (window.galleryState.msnryInstance) window.galleryState.msnryInstance.layout(); }, 150);
                }
            }
        });
        console.log("DEBUG: Step 8: Fallback window.load listener attached.");

        // ---- Cleanup Logic (Experimental) ----
        // Try to hook into Turbolinks/Turbo for cleanup before page changes
        // document.addEventListener('turbo:before-render', cleanupGallery);
        // document.addEventListener('turbolinks:before-render', cleanupGallery);
        // Hydejack might have a 'beforeunload' or 'pjax:beforeSend' type event
        // document.addEventListener('hydejack:beforeunload', cleanupGallery);

        console.log("DEBUG: Step 9: End of pagefigure.html script block.");

    </script>
</body>