---
layout: page
---

<head>
    <link href="/assets/js/lightbox.css" rel="stylesheet" />
    <style>
        .content-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .nav-button {
            padding: 10px 20px;
            margin: 0 10px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-button.active {
            background-color: rgba(79, 177, 186, 0.8);
            color: white;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .figure-grid {
            margin: 0 auto;
        }

        .figure-grid-sizer,
        .figure-grid-item {
            width: 33.333%;
        }

        .figure-grid img,
        .figure-grid a img {
            width: 100%;
            height: auto;
            display: block;
            break-inside: avoid;
        }

        .figure-grid-item img {
            padding: 5px 5px;
            border-radius: 15px;
        }

        .figure-grid a {
            text-decoration: none;
            border: none;
            outline: none;
        }

        .figure-grid a::after {
            content: none !important;
        }

        .figure-grid-item {
            background-color: transparent;
            transition: background-color 0.3s ease-in-out;
        }

        .figure-grid-item.loaded {
            background-color: transparent;
        }

        /* 恢复原始图片样式 */
        .figure-grid-item img.lozad:not([src]) {
            min-height: 300px;
            visibility: hidden;
        }

        .figure-grid-item img.loaded {
            visibility: visible;
        }

        .image-link img {
            transition: transform 0.3s ease-in-out;
        }

        .image-link img:hover {
            transform: scale(1.05);
        }

        .video-grid {
            margin: 0 auto;
        }

        .video-grid-sizer,
        .video-item {
            width: 50%;
        }

        .video-item {
            position: relative;
            overflow: hidden;
            background-color: transparent;
            border-radius: 5px;
            transition: background-color 0.3s ease-in-out;
            margin-bottom: 20px;
            padding: 0 10px;
            box-sizing: border-box;
        }

        .video-item .video-container {
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            height: auto;
        }

        .video-title {
            padding: 10px;
            font-size: 14px;
            margin-top: 5px;
            text-align: center;
        }

        .video-item.loaded {
            background-color: transparent;
        }

        .video-item .video-container iframe.video-lozad:not([src]),
        .video-item .video-container video.video-lozad:not([src]) {
            min-height: 200px;
            visibility: hidden;
        }

        .video-item iframe.loaded,
        .video-item video.loaded {
            visibility: visible;
        }

        .video-item .video-container iframe,
        .video-item .video-container video {
            display: block;
            width: 100%;
            height: auto;
            border: none;
        }

        .film-grid {
            margin: 0 auto;
        }

        .film-grid-sizer,
        .film-grid-item {
            width: 33.333%;
        }

        .film-grid img,
        .film-grid a img {
            width: 100%;
            height: auto;
            display: block;
            break-inside: avoid;
        }

        .film-grid-item img {
            padding: 5px 5px;
            border-radius: 15px;
        }

        .film-grid a {
            text-decoration: none;
            border: none;
            outline: none;
        }

        .film-grid a::after {
            content: none !important;
        }

        .film-grid-item {
            background-color: transparent;
            transition: background-color 0.3s ease-in-out;
        }

        .film-grid-item.loaded {
            background-color: transparent;
        }

        .film-grid-item img.film-lozad:not([src]) {
            min-height: 300px;
            visibility: hidden;
        }

        .film-grid-item img.loaded {
            visibility: visible;
        }

        .film-grid .image-link img {
            transition: transform 0.3s ease-in-out;
        }

        .film-grid .image-link img:hover {
            transform: scale(1.05);
        }

        @media screen and (max-width: 768px) {

            .figure-grid-sizer,
            .figure-grid-item {
                width: 50%;
            }

            .video-grid-sizer,
            .video-item {
                width: 50%;
            }

            .film-grid-sizer,
            .film-grid-item {
                width: 50%;
            }
        }

        @media screen and (max-width: 480px) {

            .figure-grid-sizer,
            .figure-grid-item {
                width: 100%;
            }

            .video-grid-sizer,
            .video-item {
                width: 100%;
            }

            .film-grid-sizer,
            .film-grid-item {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="content-nav" style="display: none;">
        <button class="nav-button image-button active" data-target="image-section" style="display: none;">Digital
            Photo</button>
        <button class="nav-button film-button" data-target="film-section" style="display: none;">Film Photo</button>
        <button class="nav-button video-button" data-target="video-section" style="display: none;">Video</button>
    </div>

    <div id="content-container">
        <div id="image-section" class="content-section active">
            {{ content }}
        </div>

        <div id="video-section" class="content-section">
            <div id="video-container"></div>
        </div>

        <div id="film-section" class="content-section">
            <div id="film-container"></div>
        </div>
    </div>

    <script src="/assets/js/lozad.js"></script>
    <script src="/assets/js/masonry.pkgd.min.js"></script>
    <script src="/assets/js/imagesloaded.pkgd.min.js"></script>
    <script src="/assets/js/lightbox-plus-jquery.js"></script>

    <script>
        /* 全局变量和状态管理 */
        var pageState = {
            resourcesLoaded: false,
            domReady: false,
            contentInitialized: false,
            jekyllContentReady: false,
            loadingImagesInProgress: false,
            scrollTimer: null,
            observers: {
                content: null,
                video: null,
                film: null,
                lozad: null,
                imageIntersection: null
            },
            masonry: {
                image: null,
                film: null
            }
        };

        /* 资源加载与初始化 */
        function loadMissingResources(callback) {
            let loadedCount = 0;
            const totalResources = 4;
            const resourceMap = [
                { check: typeof Masonry === 'undefined', src: '/assets/js/masonry.pkgd.min.js' },
                { check: typeof imagesLoaded === 'undefined', src: '/assets/js/imagesloaded.pkgd.min.js' },
                { check: typeof lozad === 'undefined', src: '/assets/js/lozad.js' },
                { check: typeof lightbox === 'undefined', src: '/assets/js/lightbox-plus-jquery.js' }
            ];

            function checkAllLoaded() {
                loadedCount++;
                if (loadedCount >= totalResources && callback) {
                    pageState.resourcesLoaded = true;
                    callback();
                }
            }

            resourceMap.forEach(function (resource) {
                if (resource.check) {
                    var script = document.createElement('script');
                    script.src = resource.src;
                    script.onload = checkAllLoaded;
                    document.head.appendChild(script);
                } else {
                    checkAllLoaded();
                }
            });
        }

        var pageLoadStart = new Date().getTime();
        var isJekyllContentReady = false;

        function detectJekyllContentVisibility() {
            var contentSection = document.getElementById('image-section');
            var hasContent = contentSection && contentSection.innerHTML.trim() !== '';
            var figureGrid = document.querySelector('.figure-grid');

            if (hasContent) {
                isJekyllContentReady = true;
                pageState.jekyllContentReady = true;
                document.dispatchEvent(new CustomEvent('jekyll-content-ready'));
                if (typeof initPage === 'function') {
                    document.body.classList.remove('initialized');
                    initPage();
                }

                setTimeout(function () {
                    var grid = document.querySelector('.figure-grid');
                    if (grid) {
                        var msnry = Masonry.data(grid);
                        if (msnry) {
                            msnry.layout();
                        }
                    }
                }, 100);
            } else {
                requestAnimationFrame(detectJekyllContentVisibility);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            pageState.domReady = true;
            detectJekyllContentVisibility();

            if (pageState.resourcesLoaded) {
                initPage();
                setupMutationObserver();
            } else {
                loadMissingResources(function () {
                    initPage();
                    setupMutationObserver();
                });
            }

            var activeTabId = 'image';
            var activeNavButton = document.querySelector('.nav-button.active');
            if (activeNavButton) {
                var targetSectionId = activeNavButton.getAttribute('data-target');
                if (targetSectionId && targetSectionId.endsWith('-section')) {
                    activeTabId = targetSectionId.replace('-section', '');
                }
            }

            initializeTab(activeTabId);
        });

        window.addEventListener('load', function () {
            pageState.domReady = true;

            if (!pageState.jekyllContentReady) {
                detectJekyllContentVisibility();
            }

            if (!document.querySelector('.figure-grid-item.loaded')) {
                if (pageState.resourcesLoaded) {
                    initPage();
                    setupMutationObserver();
                } else {
                    loadMissingResources(function () {
                        initPage();
                        setupMutationObserver();
                    });
                }
            }

            setupMutationObserver();
        });

        /* Hydejack AJAX支持 */
        window.addEventListener('hy:load', function () {
            if (!pageState.contentInitialized) {
                detectJekyllContentVisibility();
                setupMutationObserver();

                if (pageState.resourcesLoaded) {
                    initPage();
                } else {
                    loadMissingResources(function () {
                        initPage();
                    });
                }
            }
        });

        window.onerror = function (msg, url, line, col, error) {
            return false;
        };

        function safeExecute(fn, fallback) {
            try {
                return fn();
            } catch (e) {
                if (typeof fallback === 'function') {
                    return fallback();
                }
                return null;
            }
        }

        document.addEventListener('jekyll-content-ready', function () {
            if (pageState.resourcesLoaded) {
                initPage();
            } else {
                loadMissingResources(function () {
                    initPage();
                });
            }
        });

        function setupMutationObserver() {
            // 如果已有observer，先断开连接
            if (pageState.observers.content) {
                pageState.observers.content.disconnect();
            }

            var contentContainer = document.getElementById('content-container');
            var contentSection = document.getElementById('image-section');
            var videoSection = document.getElementById('video-section');
            var filmSection = document.getElementById('film-section');

            if (!contentSection && !videoSection && !filmSection && !contentContainer) {
                requestAnimationFrame(setupMutationObserver);
                return;
            }

            pageState.observers.content = new MutationObserver(function (mutations) {
                let contentChanged = false;

                mutations.forEach(function (mutation) {
                    if (mutation.type === 'childList' && !pageState.contentInitialized) {
                        contentChanged = true;
                    }
                });

                if (contentChanged) {
                    var contentDetails = {
                        hasImage: contentSection && contentSection.querySelector('.figure-grid'),
                        hasVideo: videoSection && videoSection.querySelector('.video-grid'),
                        hasFilm: filmSection && filmSection.querySelector('.film-grid')
                    };

                    if (contentDetails.hasImage || contentDetails.hasVideo || contentDetails.hasFilm) {
                        pageState.contentInitialized = true;
                        updateNavigationButtons(
                            contentDetails.hasImage,
                            contentDetails.hasVideo,
                            contentDetails.hasFilm
                        );
                        initPage();
                    }
                }
            });

            // 监听内容容器及其子元素
            if (contentContainer) {
                pageState.observers.content.observe(contentContainer, { childList: true, subtree: true });
            }

            // 同时监听各个部分
            [contentSection, videoSection, filmSection].forEach(function (section) {
                if (section) {
                    pageState.observers.content.observe(section, { childList: true, subtree: true });
                }
            });
        }

        function startInitialization() {
            if (pageState.resourcesLoaded && pageState.domReady) {
                initPage();
                setupMutationObserver();
            }
        }

        setTimeout(function () {
            initPage();
            setupMutationObserver();
        }, 0);

        loadMissingResources(function () {
            startInitialization();
        });

        setupMutationObserver();

        function initPage() {
            var now = new Date().getTime();

            var hasLoadedImages = document.querySelector('.figure-grid-item.loaded');

            if (document.querySelector('.initialized') && hasLoadedImages) {
                return;
            }

            document.body.classList.add('initialized');

            var libStatus = {
                masonry: typeof Masonry !== 'undefined',
                imagesLoaded: typeof imagesLoaded !== 'undefined',
                lozad: typeof lozad !== 'undefined',
                lightbox: typeof lightbox !== 'undefined'
            };

            if (!libStatus.masonry || !libStatus.imagesLoaded || !libStatus.lozad || !libStatus.lightbox) {
                loadMissingResources(function () {
                    setTimeout(initPage, 100);
                });
                return;
            }

            var initialContent = handleInitialContent();

            setupButtonHandlers();

            updateNavigationButtons(
                initialContent.hasImage,
                initialContent.hasVideo,
                initialContent.hasFilm
            );

            if (initialContent.hasImage) {
                initMasonry();
                forceCheckImagesLoading();
            }

            if (initialContent.hasVideo) {
                initVideoLazyLoad();
            }

            if (initialContent.hasFilm) {
                initFilmMasonry();
            }

            if (typeof lightbox !== 'undefined') {
                lightbox.option({
                    'resizeDuration': 200,
                    'wrapAround': true,
                    'fitImagesInViewport': true,
                    'disableScrolling': true
                });
            }
        }

        function forceCheckImagesLoading() {
            var lazyImages = document.querySelectorAll('.lozad');

            if (lazyImages.length === 0) {
                return;
            }

            var unloadedCount = 0;
            lazyImages.forEach(function (img) {
                var rect = img.getBoundingClientRect();
                var isInViewport = (
                    rect.top <= (window.innerHeight || document.documentElement.clientHeight) &&
                    rect.left <= (window.innerWidth || document.documentElement.clientWidth) &&
                    rect.bottom >= 0 &&
                    rect.right >= 0
                );

                if (isInViewport && !img.classList.contains('loaded')) {
                    unloadedCount++;
                }
            });

            if (window.lozadObserver) {
                try {
                    window.lozadObserver.observe();
                } catch (e) {
                }
            }

            setTimeout(function () {
                var grid = document.querySelector('.figure-grid');
                if (grid) {
                    var msnry = Masonry.data(grid);
                    if (msnry) {
                        msnry.layout();
                    }
                }
            }, 500);
        }

        function handleInitialContent() {
            var containers = document.querySelectorAll('[data-type]');

            var hasVideo = false;
            var hasFilm = false;
            var imageGrid = document.querySelector('.figure-grid');
            var hasImage = imageGrid !== null && imageGrid.innerHTML.trim() !== '';

            containers.forEach(function (container) {
                var type = container.getAttribute('data-type');

                if (type === 'video') {
                    var videoContainer = document.getElementById('video-container');
                    if (videoContainer) {
                        videoContainer.appendChild(container.cloneNode(true));
                        container.setAttribute('data-processed', 'true');
                        hasVideo = true;
                    }
                } else if (type === 'film') {
                    var filmContainer = document.getElementById('film-container');
                    if (filmContainer) {
                        filmContainer.appendChild(container.cloneNode(true));
                        container.setAttribute('data-processed', 'true');
                        hasFilm = true;
                    }
                }
            });

            containers.forEach(function (container) {
                if (container.getAttribute('data-processed') === 'true') {
                    container.remove();
                }
            });

            if (hasImage) {
                var grid = document.querySelector('.figure-grid');
                if (grid) {
                    if (typeof Masonry !== 'undefined') {
                        var msnry = Masonry.data(grid);
                        if (msnry) {
                            msnry.layout();
                        } else {
                            safeExecute(function () {
                                initMasonry();
                            });
                        }
                    }
                }
            }

            if (!hasImage && (hasVideo || hasFilm)) {
                if (hasVideo) {
                    var videoButton = document.querySelector('.video-button');
                    if (videoButton) {
                        videoButton.click();
                    }
                } else if (hasFilm) {
                    var filmButton = document.querySelector('.film-button');
                    if (filmButton) {
                        filmButton.click();
                    }
                }
            }

            return { hasVideo: hasVideo, hasFilm: hasFilm, hasImage: hasImage };
        }

        function updateNavigationButtons(hasImage, hasVideo, hasFilm) {
            var contentNav = document.querySelector('.content-nav');
            if (!contentNav) {
                return;
            }

            var contentTypeCount = (hasImage ? 1 : 0) + (hasVideo ? 1 : 0) + (hasFilm ? 1 : 0);

            var imageButton = document.querySelector('.image-button');
            var videoButton = document.querySelector('.video-button');
            var filmButton = document.querySelector('.film-button');

            if (!imageButton || !videoButton || !filmButton) {
                return;
            }

            imageButton.style.display = 'none';
            videoButton.style.display = 'none';
            filmButton.style.display = 'none';

            if (contentTypeCount <= 1) {
                contentNav.style.display = 'none';
            } else {
                contentNav.style.display = 'flex';
                if (hasImage) {
                    imageButton.style.display = 'inline-block';
                }
                if (hasVideo) {
                    videoButton.style.display = 'inline-block';
                }
                if (hasFilm) {
                    filmButton.style.display = 'inline-block';
                }
            }

            if (!hasImage && hasVideo) {
                imageButton.classList.remove('active');
                videoButton.classList.add('active');
                document.getElementById('image-section').classList.remove('active');
                document.getElementById('video-section').classList.add('active');
            }

            if (!hasImage && !hasVideo && hasFilm) {
                imageButton.classList.remove('active');
                filmButton.classList.add('active');
                document.getElementById('image-section').classList.remove('active');
                document.getElementById('film-section').classList.add('active');
            }
        }

        function setupButtonHandlers() {
            var navButtons = document.querySelectorAll('.nav-button');

            navButtons.forEach(function (button) {
                var newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
            });

            navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(function (button) {
                var targetName = button.getAttribute('data-target');

                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    var target = this.getAttribute('data-target');

                    navButtons.forEach(function (btn) {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');

                    var sections = document.querySelectorAll('.content-section');
                    sections.forEach(function (section) {
                        section.classList.remove('active');
                        section.style.display = 'none';
                    });

                    var targetSection = document.getElementById(target);
                    if (targetSection) {
                        targetSection.classList.add('active');
                        targetSection.style.display = 'block';

                        setTimeout(function () {
                            loadInitialImages();
                        }, 50);

                        var hasGrid = false;
                        if (target === 'image-section') {
                            hasGrid = !!targetSection.querySelector('.figure-grid');
                            if (hasGrid) {
                                try { initMasonry(); } catch (e) { }
                            }
                        } else if (target === 'video-section') {
                            hasGrid = !!targetSection.querySelector('.video-grid');
                            if (hasGrid) {
                                try { initVideoLazyLoad(); } catch (e) { }
                            }
                        } else if (target === 'film-section') {
                            hasGrid = !!targetSection.querySelector('.film-grid');
                            if (hasGrid) {
                                try { initFilmMasonry(); } catch (e) { }
                            }
                        }

                        setTimeout(function () {
                            updateActiveLayout();
                            loadVisibleImages();
                        }, 100);
                    }
                });
            });
        }

        function initMasonry() {
            var grid = document.querySelector('.figure-grid');
            if (!grid) {
                return;
            }

            var existingMasonry = Masonry.data(grid);
            if (existingMasonry) {
                existingMasonry.layout();
                imagesLoaded(grid).on('progress', function () {
                    existingMasonry.layout();
                }).on('always', function () {
                    existingMasonry.layout();
                });
            }

            var lazyImages = grid.querySelectorAll('.lozad');

            var msnry = existingMasonry;
            if (!existingMasonry) {
                try {
                    msnry = new Masonry(grid, {
                        itemSelector: '.figure-grid-item',
                        columnWidth: '.figure-grid-sizer',
                        percentPosition: true
                    });
                } catch (e) {
                    return null;
                }
            }

            if (window.lozadObserver && window.lozadObserver.observer) {
                window.lozadObserver.observer.disconnect();
            }

            function updateMasonryLayout() {
                var grid = document.querySelector('.figure-grid');
                if (grid) {
                    var msnry_update = Masonry.data(grid);
                    if (msnry_update) {
                        msnry_update.layout();
                        setTimeout(function () {
                            msnry_update.layout();
                        }, 100);
                    }
                }
            }

            var activeSection = document.querySelector('.content-section.active');
            if (!activeSection || activeSection.id !== 'image-section') {
                if (msnry) {
                    msnry.layout();
                }
                return msnry;
            }

            window.lozadObserver = lozad('.content-section.active .lozad', {
                rootMargin: '200px 0px',
                threshold: 0.01,
                loaded: function (el) {
                    el.classList.add('loaded');
                    var item = el.closest('.figure-grid-item');
                    if (item) {
                        item.classList.add('loaded');
                    }

                    el.style.visibility = 'visible';
                    el.style.opacity = '1';

                    imagesLoaded(el, function (instance) {
                        var grid = document.querySelector('.figure-grid');
                        if (grid) {
                            var msnry_instance = Masonry.data(grid);
                            if (msnry_instance) {
                                msnry_instance.layout();
                            }
                        }
                    });
                }
            });

            window.lozadObserver.observe();

            setTimeout(function () {
                loadInitialImages();
            }, 50);

            imagesLoaded(grid).on('progress', function (instance, image) {
                if (msnry) msnry.layout();
            }).on('always', function (instance) {
                if (msnry) msnry.layout();
                setTimeout(function () {
                    if (msnry) msnry.layout();
                }, 500);
            });

            return msnry;
        }

        function loadInitialImages() {
            var activeSection = document.querySelector('.content-section.active');
            if (!activeSection) {
                return;
            }
            var sectionId = activeSection.id;

            if (sectionId === 'image-section') {
                var viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                var loadDistance = viewportHeight * 1.2;
                var lazyImages = activeSection.querySelectorAll('img.lozad:not(.loaded)');

                lazyImages.forEach(function (img) {
                    var rect = img.getBoundingClientRect();
                    if (rect.top < loadDistance) {
                        if (img.dataset.src && !img.src) {
                            img.src = img.dataset.src;
                            img.style.visibility = 'visible';
                            img.classList.add('loaded');
                            var item = img.closest('.figure-grid-item');
                            if (item) {
                                item.classList.add('loaded');
                            }
                            setTimeout(updateActiveLayout, 50);
                        }
                    }
                });
            } else if (sectionId === 'film-section') {
                var viewportHeight = window.innerHeight || document.documentElement.clientHeight;
                var loadDistance = viewportHeight * 1.2;
                var lazyFilmImages = activeSection.querySelectorAll('img.film-lozad:not(.loaded)');

                lazyFilmImages.forEach(function (img) {
                    var rect = img.getBoundingClientRect();
                    if (rect.top < loadDistance) {
                        if (img.dataset.src && !img.src) {
                            img.src = img.dataset.src;
                            img.style.visibility = 'visible';
                            img.classList.add('loaded');
                            var item = img.closest('.film-grid-item');
                            if (item) {
                                item.classList.add('loaded');
                            }
                            setTimeout(updateActiveLayout, 50);
                        }
                    }
                });
            }
            updateActiveLayout();
        }

        function updateActiveLayout() {
            var activeSection = document.querySelector('.content-section.active');
            if (!activeSection) {
                return;
            }
            var sectionId = activeSection.id;

            if (sectionId === 'image-section') {
                var grid = document.querySelector('.figure-grid');
                if (grid) {
                    var msnry = Masonry.data(grid);
                    if (msnry) {
                        msnry.layout();
                    }
                }
            } else if (sectionId === 'film-section') {
                var filmGrid = document.querySelector('.film-grid');
                if (filmGrid) {
                    var filmMsnry = Masonry.data(filmGrid);
                    if (filmMsnry) {
                        filmMsnry.layout();
                    }
                }
            }
        }

        function loadVisibleImages() {
            var activeSection = document.querySelector('.content-section.active');
            if (!activeSection || activeSection.id !== 'image-section') {
                return;
            }
            if (pageState.loadingImagesInProgress) {
                return;
            }
            pageState.loadingImagesInProgress = true;

            var viewportHeight = window.innerHeight;
            var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            var viewportTop = scrollTop;
            var viewportBottom = viewportTop + viewportHeight;
            var buffer = viewportHeight * 1.5;

            var extendedTop = viewportTop - buffer / 2;
            var extendedBottom = viewportBottom + buffer / 2;

            var imgElements = activeSection.querySelectorAll('img[data-src]:not([data-loaded="true"]):not([data-loading="true"])');

            if (imgElements.length === 0) {
                pageState.loadingImagesInProgress = false;
                return;
            }

            var imagesInViewport = [];
            imgElements.forEach(function (img) {
                var rect = img.getBoundingClientRect();
                var imgTop = rect.top + scrollTop;
                var imgBottom = imgTop + rect.height;

                if (imgBottom >= extendedTop && imgTop <= extendedBottom) {
                    var imgCenter = imgTop + rect.height / 2;
                    var viewportCenter = viewportTop + viewportHeight / 2;
                    var distance = Math.abs(imgCenter - viewportCenter);
                    imagesInViewport.push({ element: img, distance: distance, visible: (imgBottom >= viewportTop && imgTop <= viewportBottom) });
                }
            });

            imagesInViewport.sort(function (a, b) {
                if (a.visible && !b.visible) return -1;
                if (!a.visible && b.visible) return 1;
                return a.distance - b.distance;
            });

            var maxImagesPerBatch = 5;
            var imagesToLoad = imagesInViewport.slice(0, maxImagesPerBatch);

            if (imagesToLoad.length === 0) {
                pageState.loadingImagesInProgress = false;
                return;
            }

            var loadedCount = 0;
            var totalToLoad = imagesToLoad.length;
            var batchFinished = function () {
                pageState.loadingImagesInProgress = false;
                requestAnimationFrame(loadVisibleImages);
            };

            imagesToLoad.forEach(function (imgData) {
                var img = imgData.element;
                var src = img.getAttribute('data-src');

                if (src) {
                    img.setAttribute('data-loading', 'true');
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.3s ease';

                    img.onload = function () {
                        img.removeAttribute('data-src');
                        img.setAttribute('data-loaded', 'true');
                        img.removeAttribute('data-loading');
                        img.style.opacity = '1';
                        var gridItem = img.closest('.figure-grid-item');
                        if (gridItem) {
                            gridItem.classList.add('loaded');
                        }
                        loadedCount++;
                        updateActiveLayout();
                        if (loadedCount >= totalToLoad) { batchFinished(); }
                    };

                    img.onerror = function () {
                        img.removeAttribute('data-loading');
                        loadedCount++;
                        if (loadedCount >= totalToLoad) { batchFinished(); }
                    };

                    img.src = src;
                } else {
                    loadedCount++;
                    if (loadedCount >= totalToLoad) { batchFinished(); }
                }
            });
        }

        function initFilmMasonry() {
            var filmSection = document.getElementById('film-section');
            if (!filmSection || !filmSection.classList.contains('active')) {
                return;
            }

            var grid = filmSection.querySelector('.film-grid');
            if (!grid) {
                return;
            }

            if (!window.filmMasonryInstance) {
                window.filmMasonryInstance = {};
            }

            var msnry;
            if (window.filmMasonryInstance.grid === grid && Masonry.data(grid)) {
                msnry = window.filmMasonryInstance.masonry;
                if (msnry) {
                    msnry.layout();
                    imagesLoaded(grid).on('progress', function () {
                        if (msnry) msnry.layout();
                    }).on('always', function () {
                        if (msnry) msnry.layout();
                    });
                }
            } else {
                try {
                    msnry = new Masonry(grid, {
                        itemSelector: '.film-grid-item',
                        columnWidth: '.film-grid-sizer',
                        percentPosition: true,
                        transitionDuration: '0.3s'
                    });
                    window.filmMasonryInstance.grid = grid;
                    window.filmMasonryInstance.masonry = msnry;
                    imagesLoaded(grid).on('progress', function () {
                        if (msnry) msnry.layout();
                    }).on('always', function () {
                        if (msnry) msnry.layout();
                    });
                } catch (e) {
                    return null;
                }
            }

            if (window.filmObserver) {
                window.filmObserver.disconnect();
            }

            var lazyFilmImages = filmSection.querySelectorAll('img.film-lozad:not(.loaded)');

            if (lazyFilmImages.length === 0) {
                if (msnry) msnry.layout();
                return msnry;
            }

            window.filmObserver = new IntersectionObserver(function (entries, observer) {
                var viewportHeight = window.innerHeight;
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                var viewportCenter = scrollTop + (viewportHeight / 2);
                var imagesToLoad = [];

                entries.forEach(function (entry) {
                    if (entry.isIntersecting) {
                        var img = entry.target;
                        var src = img.getAttribute('data-src');
                        if (src && !img.hasAttribute('data-loading') && !img.hasAttribute('data-loaded')) {
                            var rect = img.getBoundingClientRect();
                            var imgTop = rect.top + scrollTop;
                            var imgCenter = imgTop + (rect.height / 2);
                            var distance = Math.abs(imgCenter - viewportCenter);
                            imagesToLoad.push({ img: img, src: src, distance: distance });
                        }
                    }
                });

                imagesToLoad.sort(function (a, b) { return a.distance - b.distance; });

                var maxImagesPerBatch = 3;
                var batchToLoad = imagesToLoad.slice(0, maxImagesPerBatch);

                var loadedCount = 0;
                batchToLoad.forEach(function (item) {
                    var img = item.img;
                    var src = item.src;

                    img.setAttribute('data-loading', 'true');
                    img.style.opacity = '0';
                    img.style.transition = 'opacity 0.3s ease';

                    img.onload = function () {
                        img.removeAttribute('data-src');
                        img.removeAttribute('data-loading');
                        img.setAttribute('data-loaded', 'true');
                        img.classList.add('loaded');
                        img.style.opacity = '1';
                        var gridItem = img.closest('.film-grid-item');
                        if (gridItem) {
                            gridItem.classList.add('loaded');
                        }
                        if (msnry) {
                            msnry.layout();
                        }
                        observer.unobserve(img);
                        loadedCount++;
                    };

                    img.onerror = function () {
                        img.removeAttribute('data-loading');
                        observer.unobserve(img);
                        loadedCount++;
                    };
                    img.src = src;
                });

            }, {
                root: null,
                rootMargin: '200px',
                threshold: 0.01
            });

            lazyFilmImages.forEach(function (img) {
                window.filmObserver.observe(img);
            });

            loadVisibleFilmImages();

            return msnry;
        }

        function loadVisibleFilmImages() {
            var filmSection = document.getElementById('film-section');
            if (!filmSection || !filmSection.classList.contains('active')) {
                return;
            }

            var viewportHeight = window.innerHeight;
            var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            var viewportTop = scrollTop;
            var viewportBottom = viewportTop + viewportHeight;
            var buffer = viewportHeight * 0.5;

            var imagesInViewport = [];
            var lazyImages = filmSection.querySelectorAll('img.film-lozad:not(.loaded):not([data-loading])');

            lazyImages.forEach(function (img) {
                var rect = img.getBoundingClientRect();
                var imgTop = rect.top + scrollTop;
                var imgBottom = imgTop + rect.height;

                if (imgBottom >= (viewportTop - buffer) && imgTop <= (viewportBottom + buffer)) {
                    var src = img.getAttribute('data-src');
                    if (src) {
                        imagesInViewport.push(img);
                    }
                }
            });

            var maxImmediateLoad = 5;
            imagesInViewport.slice(0, maxImmediateLoad).forEach(function (img) {
                var src = img.getAttribute('data-src');
                if (src && !img.hasAttribute('data-loading') && !img.hasAttribute('data-loaded')) {
                    img.setAttribute('data-loading', 'true');

                    img.onload = function () {
                        img.removeAttribute('data-src');
                        img.removeAttribute('data-loading');
                        img.setAttribute('data-loaded', 'true');
                        img.classList.add('loaded');
                        var gridItem = img.closest('.film-grid-item');
                        if (gridItem) gridItem.classList.add('loaded');
                        var filmMsnry = window.filmMasonryInstance ? window.filmMasonryInstance.masonry : null;
                        if (filmMsnry) {
                            filmMsnry.layout();
                        }
                        if (window.filmObserver) window.filmObserver.unobserve(img);
                    };
                    img.onerror = function () {
                        img.removeAttribute('data-loading');
                        if (window.filmObserver) window.filmObserver.unobserve(img);
                    };
                    img.src = src;
                }
            });
        }

        function initVideoLazyLoad() {
            var videoSection = document.getElementById('video-section');
            if (!videoSection || !videoSection.classList.contains('active')) {
                return;
            }

            if (window.videoObserver) {
                window.videoObserver.disconnect();
            }

            var lazyVideos = videoSection.querySelectorAll('video[data-src]:not([data-loaded="true"]):not([data-loading="true"])');

            if (lazyVideos.length === 0) {
                return;
            }

            window.videoObserver = new IntersectionObserver(function (entries, observer) {
                var viewportHeight = window.innerHeight;
                var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                var viewportCenter = scrollTop + (viewportHeight / 2);
                var videosToLoad = [];

                entries.forEach(function (entry) {
                    if (entry.isIntersecting) {
                        var video = entry.target;
                        var src = video.getAttribute('data-src');
                        var poster = video.getAttribute('data-poster');
                        if (src && !video.hasAttribute('data-loading') && !video.hasAttribute('data-loaded')) {
                            var rect = video.getBoundingClientRect();
                            var videoTop = rect.top + scrollTop;
                            var videoCenter = videoTop + (rect.height / 2);
                            var distance = Math.abs(videoCenter - viewportCenter);
                            videosToLoad.push({ video: video, src: src, poster: poster, distance: distance });
                        }
                    }
                });

                videosToLoad.sort(function (a, b) { return a.distance - b.distance; });

                var maxVideosPerBatch = 2;
                var batchToLoad = videosToLoad.slice(0, maxVideosPerBatch);

                batchToLoad.forEach(function (item) {
                    var video = item.video;
                    var src = item.src;
                    var poster = item.poster;

                    video.setAttribute('data-loading', 'true');

                    if (poster) {
                        video.setAttribute('poster', poster);
                    }

                    var existingSource = video.querySelector('source');
                    if (existingSource) {
                        existingSource.src = src;
                    } else {
                        var source = document.createElement('source');
                        source.src = src;
                        source.type = 'video/mp4';
                        video.appendChild(source);
                    }

                    video.load();

                    video.removeAttribute('data-src');
                    video.setAttribute('data-loaded', 'true');
                    video.removeAttribute('data-loading');

                    var videoItem = video.closest('.video-item');
                    if (videoItem) {
                        videoItem.classList.add('loaded');
                    }

                    observer.unobserve(video);
                });
            }, {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            });

            lazyVideos.forEach(function (video) {
                window.videoObserver.observe(video);
            });

            loadVisibleVideos();
        }

        function loadVisibleVideos() {
            var videoSection = document.getElementById('video-section');
            if (!videoSection || !videoSection.classList.contains('active')) {
                return;
            }

            var viewportHeight = window.innerHeight;
            var scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            var viewportTop = scrollTop;
            var viewportBottom = viewportTop + viewportHeight;
            var buffer = viewportHeight * 0.5;

            var videosInViewport = [];
            var lazyVideos = videoSection.querySelectorAll('video[data-src]:not([data-loaded="true"]):not([data-loading="true"])');

            lazyVideos.forEach(function (video) {
                var rect = video.getBoundingClientRect();
                var videoTop = rect.top + scrollTop;
                var videoBottom = videoTop + rect.height;

                if (videoBottom >= (viewportTop - buffer) && videoTop <= (viewportBottom + buffer)) {
                    var src = video.getAttribute('data-src');
                    if (src) {
                        videosInViewport.push(video);
                    }
                }
            });

            var maxImmediateLoad = 2;
            videosInViewport.slice(0, maxImmediateLoad).forEach(function (video) {
                var src = video.getAttribute('data-src');
                var poster = video.getAttribute('data-poster');
                if (src && !video.hasAttribute('data-loading') && !video.hasAttribute('data-loaded')) {
                    video.setAttribute('data-loading', 'true');

                    if (poster) video.setAttribute('poster', poster);

                    var existingSource = video.querySelector('source');
                    if (existingSource) {
                        existingSource.src = src;
                    } else {
                        var source = document.createElement('source');
                        source.src = src;
                        source.type = 'video/mp4';
                        video.appendChild(source);
                    }
                    video.load();
                    video.removeAttribute('data-src');
                    video.setAttribute('data-loaded', 'true');
                    video.removeAttribute('data-loading');
                    var videoItem = video.closest('.video-item');
                    if (videoItem) videoItem.classList.add('loaded');
                    if (window.videoObserver) window.videoObserver.unobserve(video);
                }
            });
        }

        /* 滚动处理 - 使用requestAnimationFrame */
        window.addEventListener('scroll', function () {
            if (pageState.scrollTimer) {
                cancelAnimationFrame(pageState.scrollTimer);
            }

            pageState.scrollTimer = requestAnimationFrame(function () {
                var activeSection = document.querySelector('.content-section.active');
                if (activeSection) {
                    if (activeSection.id === 'image-section') {
                        if (!pageState.loadingImagesInProgress) {
                            loadVisibleImages();
                        }
                    } else if (activeSection.id === 'film-section') {
                        loadVisibleFilmImages();
                    } else if (activeSection.id === 'video-section') {
                        loadVisibleVideos();
                    }
                }
            });
        }, { passive: true });

        function initializeTab(tabId) {
            var contentSections = document.querySelectorAll('.content-section');
            contentSections.forEach(function (section) {
                section.classList.remove('active');
                section.style.display = 'none';
            });

            var activeSection = document.getElementById(tabId + '-section');
            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
            }

            var navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(function (button) {
                button.classList.remove('active');
                if (button.getAttribute('data-target') === tabId + '-section') {
                    button.classList.add('active');
                }
            });

            if (tabId === 'image') {
                setTimeout(function () {
                    initMasonry();
                    loadVisibleImages();
                }, 100);
            } else if (tabId === 'film') {
                setTimeout(function () {
                    initFilmMasonry();
                    loadVisibleFilmImages();
                }, 100);
            } else if (tabId === 'video') {
                setTimeout(function () {
                    initVideoLazyLoad();
                    loadVisibleVideos();
                }, 100);
            }
        }

        pageState.loadingImagesInProgress = false;
    </script>
</body>