<div id="_navbar" class="navbar fixed-top">
    <div class="content">
        <span class="sr-only">{{ site.data.strings.jump_to | default:"Jump to" }}{{ site.data.strings.colon |
            default:":" }}</span>
        <div class="nav-btn-bar">
            <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
                <span class="sr-only">{{ site.data.strings.navigation | default:"Navigation" }}</span>
                <span class="icon-menu"></span>
            </a>

            <!-- Navbar Search Component -->
            <div id="navbar-search-component" style="display:inline-block; position:relative;">
                <button id="navbar-search-toggle" class="nav-btn no-hover" aria-label="Search">
                    <span class="icon-search"></span>
                </button>

                <div id="navbar-search-dropdown"
                    style="display:none; position:absolute; top:100%; left:0; width:300px; background:var(--body-bg); border:1px solid var(--border-color); box-shadow:0 4px 6px rgba(0,0,0,0.1); border-radius:4px; padding:10px; z-index:9999;">
                    <input type="text" id="navbar-search-input" placeholder="Search..."
                        style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--body-bg); color:var(--body-color);">
                    <ul id="navbar-search-results"
                        style="list-style:none; padding:0; margin-top:10px; max-height:300px; overflow-y:auto; margin-bottom:0;">
                    </ul>
                </div>
            </div>

            <div class="nav-span"></div>

            <!-- Language Toggle Component -->
            <a id="_lang-toggle" class="nav-btn no-hover" href="javascript:void(0)" aria-label="Toggle Language"
                title="Switch Language / 切换语言">
                <span class="icon-lang-custom"></span>
            </a>
        </div>
    </div>
</div>
<hr class="sr-only" hidden />

<style>
    #navbar-search-results li {
        padding: 5px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    #navbar-search-results li a {
        text-decoration: none;
        display: block;
    }

    /* Dark mode tweaks if not handled by vars */
    body.dark-mode #navbar-search-dropdown {
        background: #2a2d2f;
        border-color: #444;
    }

    body.dark-mode #navbar-search-input {
        background: #333;
        border-color: #555;
        color: #fff;
    }

    .search-result-selected {
        background-color: rgba(125, 125, 125, 0.1);
    }

    body.dark-mode .search-result-selected {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .search-snippet {
        font-size: 0.8em;
        color: var(--body-color);
        opacity: 0.8;
        margin-top: 2px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .search-match {
        font-weight: bold;
        color: var(--heading-color);
        background: rgba(255, 255, 0, 0.2);
    }

    body.dark-mode .search-match {
        background: rgba(255, 255, 0, 0.2);
        color: #fff;
    }

    /* Language Toggle Visibility */
    /* By default show both or let logic handle - typically we hide the non-active one */
    /* Assuming content is marked with .lang-en and .lang-zh */
    body.lang-zh .lang-en,
    body.lang-zh .en {
        display: none !important;
    }

    body.lang-en .lang-zh,
    body.lang-en .zh {
        display: none !important;
    }

    /* Flex Order Control */
    .nav-btn-bar {
        display: flex !important;
        align-items: center;
    }

    #_menu {
        order: 1;
    }

    #navbar-search-component {
        order: 2;
    }

    #_dark-mode {
        order: 3 !important;
    }

    #_lang-toggle {
        order: 4;
    }

    .nav-span {
        order: 5;
    }

    /* Colored Icon using Mask */
    .icon-lang-custom {
        display: inline-block;
        width: 20px;
        height: 20px;
        background-color: currentColor;
        -webkit-mask-image: url('{{ "/assets/img/lang-icon.png" | relative_url }}');
        mask-image: url('{{ "/assets/img/lang-icon.png" | relative_url }}');
        -webkit-mask-size: contain;
        mask-size: contain;
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-position: center;
        mask-position: center;
        vertical-align: middle;
    }
</style>

<script>
    (function () {
        const state = window.NavbarSearchState || (window.NavbarSearchState = {
            searchIndex: [],
            isIndexLoaded: false,
            isIndexLoading: false
        });

        function loadSearchIndex() {
            if (state.isIndexLoaded || state.isIndexLoading) return;

            state.isIndexLoading = true;
            const searchJsonUrl = '{{ "/search.json" | relative_url }}';
            fetch(searchJsonUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    state.searchIndex = data;
                    state.isIndexLoaded = true;
                })
                .catch(err => console.error('Failed to load search index', err))
                .finally(() => {
                    state.isIndexLoading = false;
                });
        }

        function initNavbarSearch() {
            const root = document.getElementById('navbar-search-component');
            if (!root) return;

            const toggleBtn = document.getElementById('navbar-search-toggle');
            const dropdown = document.getElementById('navbar-search-dropdown');
            const input = document.getElementById('navbar-search-input');
            const resultsList = document.getElementById('navbar-search-results');

            if (!toggleBtn || !dropdown || !input || !resultsList) return;

            if (!root.dataset.navbarSearchInitialized) {
                root.dataset.navbarSearchInitialized = 'true';

                toggleBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isHidden = dropdown.style.display === 'none' || dropdown.style.display === '';
                    dropdown.style.display = isHidden ? 'block' : 'none';

                    if (isHidden) {
                        input.focus();
                        loadSearchIndex();
                    }
                });
            }

            if (!input.dataset.navbarSearchBound) {
                input.dataset.navbarSearchBound = 'true';
                let selectedIndex = -1;

                function updateSelection() {
                    const items = resultsList.querySelectorAll('li');
                    items.forEach((item, index) => {
                        if (index === selectedIndex) {
                            item.classList.add('search-result-selected');
                            item.scrollIntoView({ block: 'nearest' });
                        } else {
                            item.classList.remove('search-result-selected');
                        }
                    });
                }

                input.addEventListener('input', function () {
                    const rawQuery = this.value.trim();
                    const query = rawQuery.toLowerCase();
                    const isCjkQuery = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uac00-\ud7af]/.test(rawQuery);
                    const minLength = isCjkQuery ? 1 : 2;
                    selectedIndex = -1;

                    if (query.length < minLength) {
                        resultsList.innerHTML = '';
                        return;
                    }

                    if (!state.isIndexLoaded) {
                        resultsList.innerHTML = '<li style="opacity:0.6; font-size:0.9em; padding:5px;">Loading search data...</li>';
                        loadSearchIndex();
                        return;
                    }

                    const maxSnippetsPerItem = 2;
                    const snippetWindow = 40;

                    const results = state.searchIndex.reduce((acc, item) => {
                        if (acc.length >= 10) return acc;

                        const title = item.title ? item.title.toLowerCase() : '';
                        const titleZh = item.title_zh ? item.title_zh.toLowerCase() : '';
                        const content = item.content ? item.content.toLowerCase() : '';

                        const titleMatch = title.includes(query) || titleZh.includes(query);
                        const contentMatches = [];

                        if (content && query) {
                            let matchIndex = content.indexOf(query);
                            while (matchIndex !== -1) {
                                contentMatches.push(matchIndex);
                                matchIndex = content.indexOf(query, matchIndex + query.length);
                            }
                        }

                        if (titleMatch || contentMatches.length > 0) {
                            const snippets = contentMatches.slice(0, maxSnippetsPerItem).map(index => {
                                const start = Math.max(0, index - snippetWindow);
                                const end = Math.min(content.length, index + query.length + snippetWindow);
                                let snippetText = item.content.substring(start, end);

                                const regex = new RegExp(`(${query})`, 'gi');
                                snippetText = snippetText.replace(regex, '<span class="search-match">$1</span>');

                                return `...${snippetText}...`;
                            });

                            acc.push({
                                displayTitle: isCjkQuery ? (item.title_zh || item.title) : (item.title || item.title_zh),
                                url: item.url,
                                date: item.date,
                                image: item.image,
                                snippets: snippets
                            });
                        }
                        return acc;
                    }, []);


                    if (results.length > 0) {
                        resultsList.innerHTML = results.map((item, index) => `
            <li data-index="${index}">
              <a href="${item.url}" style="display: flex; align-items: start; gap: 10px; text-decoration: none;">
                ${item.image ? `<img src="${item.image}" alt="" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; flex-shrink: 0; margin-top: 2px;">` : ''}
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight:bold; font-size: 0.9em; color: var(--heading-color);">${item.displayTitle}</div>
                    ${item.snippets.length > 0 ?
                                `<div class="search-snippet">${item.snippets.join('<br>')}</div>` :
                                (item.date ? `<div style="font-size:0.7em; opacity:0.7;">${item.date}</div>` : '')
                            }
                </div>
              </a>
            </li>
          `).join('');
                    } else {
                        resultsList.innerHTML = '<li style="opacity:0.6; font-size:0.9em; padding:5px;">No results found</li>';
                    }
                });

                input.addEventListener('keydown', function (e) {
                    const items = resultsList.querySelectorAll('li');
                    if (items.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex++;
                        if (selectedIndex >= items.length) selectedIndex = 0;
                        updateSelection();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex--;
                        if (selectedIndex < 0) selectedIndex = items.length - 1;
                        updateSelection();
                    } else if (e.key === 'Enter') {
                        if (selectedIndex > -1 && items[selectedIndex]) {
                            e.preventDefault();
                            const link = items[selectedIndex].querySelector('a');
                            if (link) link.click();
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.style.display = 'none';
                        selectedIndex = -1;
                    }
                });
            }

            if (!document.body.dataset.navbarSearchDocBound) {
                document.body.dataset.navbarSearchDocBound = 'true';

                document.addEventListener('click', function (e) {
                    const dropdownEl = document.getElementById('navbar-search-dropdown');
                    const toggleBtnEl = document.getElementById('navbar-search-toggle');

                    if (!dropdownEl || !toggleBtnEl) return;
                    if (dropdownEl.style.display !== 'block') return;

                    if (dropdownEl.contains(e.target) || toggleBtnEl.contains(e.target)) {
                        return;
                    }

                    dropdownEl.style.display = 'none';
                });
            }
        }

        const deferredInit = function () {
            requestAnimationFrame(initNavbarSearch);
        };

        document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
        window.addEventListener('hy:pjax:end', deferredInit);

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            deferredInit();
        }
    })();

    (function () {
        const THEME_KEY = 'site_theme_mode';
        const MODE_LIGHT = 'light';
        const MODE_DARK = 'dark';
        const CLASS_LIGHT = 'light-mode';
        const CLASS_DARK = 'dark-mode';

        function safeGet(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                return null;
            }
        }

        function safeSet(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
            }
        }

        function safeRemove(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
            }
        }

        function normalizeMode(value) {
            if (value === MODE_LIGHT || value === MODE_DARK) {
                return value;
            }
            return null;
        }

        function readBodyMode() {
            const body = document.body;
            if (!body) return null;
            if (body.classList.contains(CLASS_DARK)) return MODE_DARK;
            if (body.classList.contains(CLASS_LIGHT)) return MODE_LIGHT;
            return null;
        }

        function applyMode(mode) {
            const body = document.body;
            if (!body) return;
            body.classList.remove(CLASS_LIGHT, CLASS_DARK);
            if (mode === MODE_LIGHT) {
                body.classList.add(CLASS_LIGHT);
            } else if (mode === MODE_DARK) {
                body.classList.add(CLASS_DARK);
            }
        }

        let lastStored = null;

        function persistMode() {
            const mode = readBodyMode();
            if (mode === lastStored) return;
            lastStored = mode;
            if (mode) {
                safeSet(THEME_KEY, mode);
            } else {
                safeRemove(THEME_KEY);
            }
        }

        function initThemePreference() {
            const body = document.body;
            if (!body) return;

            const stored = normalizeMode(safeGet(THEME_KEY));
            if (stored) {
                applyMode(stored);
            }

            if (body.dataset.themeModeObserver) return;
            body.dataset.themeModeObserver = 'true';

            const observer = new MutationObserver(function (mutations) {
                for (let i = 0; i < mutations.length; i++) {
                    if (mutations[i].attributeName === 'class') {
                        persistMode();
                        break;
                    }
                }
            });

            observer.observe(body, { attributes: true, attributeFilter: ['class'] });
        }

        const deferredInit = function () {
            requestAnimationFrame(initThemePreference);
        };

        document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
        window.addEventListener('hy:pjax:end', deferredInit);

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            deferredInit();
        }
    })();

    (function () {
        const LANG_KEY = 'site_language';
        const DEFAULT_LANG = 'en';

        function getPreferredLang() {
            const stored = localStorage.getItem(LANG_KEY);
            if (stored) return stored;
            const browser = navigator.language || navigator.userLanguage;
            if (browser && browser.toLowerCase().startsWith('zh')) {
                return 'zh';
            }
            return DEFAULT_LANG;
        }

        function setLang(lang) {
            document.body.classList.remove('lang-zh', 'lang-en');
            document.body.classList.add('lang-' + lang);
            localStorage.setItem(LANG_KEY, lang);

            const btn = document.getElementById('_lang-toggle');
            if (btn) {
                btn.setAttribute('title', lang === 'zh' ? 'Switch to English' : '切换到中文');
            }

            const searchInput = document.getElementById('navbar-search-input');
            if (searchInput) {
                searchInput.placeholder = lang === 'zh' ? '搜索...' : 'Search...';
            }
        }

        function toggleLang() {
            const current = document.body.classList.contains('lang-zh') ? 'zh' : 'en';
            const next = current === 'zh' ? 'en' : 'zh';
            setLang(next);
        }

        const initialLang = getPreferredLang();
        setLang(initialLang);

        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('_lang-toggle');
            if (btn) {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleLang();
                });
                btn.setAttribute('title', initialLang === 'zh' ? 'Switch to English' : '切换到中文');
            }
        });
    })();
</script>
