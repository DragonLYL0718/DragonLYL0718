<div id="_navbar" class="navbar fixed-top">
    <div class="content">
        <span class="sr-only">{{ site.data.strings.jump_to | default:"Jump to" }}{{ site.data.strings.colon |
            default:":" }}</span>
        <div class="nav-btn-bar">
            <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
                <span class="sr-only">{{ site.data.strings.navigation | default:"Navigation" }}</span>
                <span class="icon-menu"></span>
            </a>

            <!-- Navbar Search Component -->
            <div id="navbar-search-component" class="navbar-search-component">
                <button id="navbar-search-toggle" class="nav-btn no-hover" aria-label="Search">
                    <span class="icon-search"></span>
                </button>

                <div class="navbar-search-input-wrapper">
                    <input type="text" id="navbar-search-input"
                        placeholder="{{ site.data.strings.search | default:'Search...' }}">
                </div>

                <div id="navbar-search-dropdown" class="navbar-search-dropdown">
                    <ul id="navbar-search-results"></ul>
                </div>
            </div>

            <div class="nav-span"></div>

            <!-- Language Toggle Component -->
            <a id="_lang-toggle" class="nav-btn no-hover" href="javascript:void(0)" aria-label="Toggle Language"
                title="Switch Language / 切换语言">
                <span class="icon-lang-custom"></span>
            </a>
        </div>
    </div>
</div>
<hr class="sr-only" hidden />

<style>
    /* Navbar Search Component Styles */
    .navbar-search-component {
        display: flex;
        align-items: center;
        position: relative;
        order: 2;
        flex-grow: 0;
        transition: flex-grow 0.35s ease;
    }

    #navbar-search-toggle {
        z-index: 2;
        flex-shrink: 0;
        opacity: 1;
        transform: scale(1);
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .navbar-search-input-wrapper {
        position: relative;
        overflow: hidden;
        width: 0;
        opacity: 0;
        transition: width 0.35s ease, opacity 0.25s ease;
        margin-left: 0;
    }

    /* Active State: Expanded */
    .navbar-search-component.active {
        flex-grow: 1;
    }

    .navbar-search-component.active #navbar-search-toggle {
        position: absolute;
        opacity: 0;
        pointer-events: none;
        transform: scale(0.8);
    }

    .navbar-search-component.active .navbar-search-input-wrapper {
        width: 100%;
        opacity: 1;
        pointer-events: auto;
    }

    /* Closing State: Smooth transition back */
    .navbar-search-component.closing {
        flex-grow: 1;
    }

    .navbar-search-component.closing #navbar-search-toggle {
        position: absolute;
        opacity: 0;
        pointer-events: none;
        transform: scale(0.8);
    }

    .navbar-search-component.closing .navbar-search-input-wrapper {
        width: 0;
        opacity: 0;
        pointer-events: none;
    }

    #navbar-search-input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background: var(--body-bg);
        color: var(--body-color);
        outline: none;
        font-size: 0.9em;
    }

    #navbar-search-input:focus {
        border-color: var(--link-color);
    }

    /* Dropdown Results */
    .navbar-search-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        left: 0;
        margin-top: 5px;
        width: 100%;
        /* Match parent width */
        background: var(--body-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        padding: 5px 0;
        z-index: 9999;
    }

    .navbar-search-component.active.has-results .navbar-search-dropdown {
        display: block;
    }

    #navbar-search-results {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 300px;
        overflow-y: auto;
    }

    #navbar-search-results li {
        padding: 8px 15px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    #navbar-search-results li a {
        text-decoration: none;
        display: block;
    }

    /* Dark mode tweaks if not handled by vars */
    body.dark-mode #navbar-search-dropdown {
        background: #2a2d2f;
        border-color: #444;
    }

    body.dark-mode #navbar-search-input {
        background: #333;
        border-color: #555;
        color: #fff;
    }

    .search-result-selected {
        background-color: rgba(125, 125, 125, 0.1);
    }

    body.dark-mode .search-result-selected {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .search-snippet {
        font-size: 0.8em;
        color: var(--body-color);
        opacity: 0.8;
        margin-top: 2px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .search-match {
        font-weight: bold;
        color: var(--heading-color);
        background: rgba(255, 255, 0, 0.2);
    }

    body.dark-mode .search-match {
        background: rgba(255, 255, 0, 0.2);
        color: #fff;
    }

    /* Language Toggle Visibility */
    /* Hide content based on language class on body */
    body.lang-zh .lang-en,
    body.lang-zh .en {
        display: none !important;
    }

    body.lang-en .lang-zh,
    body.lang-en .zh {
        display: none !important;
    }

    /* Flex Order Control */
    .nav-btn-bar {
        display: flex !important;
        align-items: center;
        width: 100%;
        /* Ensure bar fills the container */
    }

    #_menu {
        order: 1;
    }

    #navbar-search-component {
        order: 2;
    }

    /* Smoothly collapse spacer when search is active */
    .navbar-search-component.active~.nav-span,
    .navbar-search-component.closing~.nav-span {
        flex-grow: 0.0001;
        width: 0;
    }

    #_dark-mode {
        order: 3 !important;
    }

    #_lang-toggle {
        order: 4;
    }

    .nav-span {
        order: 5;
        flex-grow: 1;
        width: auto;
        /* Allow it to take space */
        transition: flex-grow 0.4s ease, width 0.4s ease;
    }

    /* Colored Icon using Mask */
    .icon-lang-custom {
        display: inline-block;
        width: 20px;
        height: 20px;
        background-color: currentColor;
        -webkit-mask-image: url('{{ "/assets/img/lang-icon.png" | relative_url }}');
        mask-image: url('{{ "/assets/img/lang-icon.png" | relative_url }}');
        -webkit-mask-size: contain;
        mask-size: contain;
        -webkit-mask-repeat: no-repeat;
        mask-repeat: no-repeat;
        -webkit-mask-position: center;
        mask-position: center;
        vertical-align: middle;
    }
</style>

<script>
    (function () {
        const state = window.NavbarSearchState || (window.NavbarSearchState = {
            searchIndex: [],
            isIndexLoaded: false,
            isIndexLoading: false
        });

        function loadSearchIndex() {
            if (state.isIndexLoaded || state.isIndexLoading) return;

            state.isIndexLoading = true;
            const searchJsonUrl = '{{ "/search.json" | relative_url }}';
            fetch(searchJsonUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    state.searchIndex = data;
                    state.isIndexLoaded = true;
                })
                .catch(err => console.error('Failed to load search index', err))
                .finally(() => {
                    state.isIndexLoading = false;
                });
        }

        function initNavbarSearch() {
            const root = document.getElementById('navbar-search-component');
            if (!root) return;

            const toggleBtn = document.getElementById('navbar-search-toggle');
            const dropdown = document.getElementById('navbar-search-dropdown');
            const input = document.getElementById('navbar-search-input');
            const resultsList = document.getElementById('navbar-search-results');
            const inputWrapper = root.querySelector('.navbar-search-input-wrapper');

            if (!toggleBtn || !dropdown || !input || !resultsList || !inputWrapper) return;

            let closeTimer = null;

            function finishClose() {
                root.classList.remove('closing', 'active');
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            }

            function closeSearch() {
                if (!root.classList.contains('active') || root.classList.contains('closing')) return;

                /* Add closing class to trigger shrink animation */
                root.classList.add('closing');
                root.classList.remove('has-results');

                /* Wait for the animation to complete, then remove all classes */
                closeTimer = window.setTimeout(function () {
                    finishClose();
                }, 380);
            }

            if (!root.dataset.navbarSearchInitialized) {
                root.dataset.navbarSearchInitialized = 'true';

                toggleBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isActive = root.classList.contains('active');

                    if (isActive) {
                        if (input.value.trim() !== '') {
                            input.focus();
                        } else {
                            closeSearch();
                        }
                    } else {
                        root.classList.add('active');
                        input.focus();
                        loadSearchIndex();
                    }
                });

                document.addEventListener('click', function (e) {
                    if (!root.contains(e.target)) {
                        closeSearch();
                    }
                });
            }

            if (!resultsList.dataset.navbarSearchResultsBound) {
                resultsList.dataset.navbarSearchResultsBound = 'true';
                resultsList.addEventListener('click', function (e) {
                    const link = e.target.closest('a');
                    if (!link || !resultsList.contains(link)) return;
                    closeSearch();
                });
            }

            if (!input.dataset.navbarSearchBound) {
                input.dataset.navbarSearchBound = 'true';
                let selectedIndex = -1;

                function updateSelection() {
                    const items = resultsList.querySelectorAll('li');
                    items.forEach((item, index) => {
                        if (index === selectedIndex) {
                            item.classList.add('search-result-selected');
                            item.scrollIntoView({ block: 'nearest' });
                        } else {
                            item.classList.remove('search-result-selected');
                        }
                    });
                }

                input.addEventListener('input', function () {
                    const rawQuery = this.value.trim();
                    const query = rawQuery.toLowerCase();
                    const isCjkQuery = /[\u3040-\u30ff\u3400-\u4dbf\u4e00-\u9fff\uac00-\ud7af]/.test(rawQuery);
                    const minLength = isCjkQuery ? 1 : 2;
                    selectedIndex = -1;

                    if (query.length < minLength) {
                        resultsList.innerHTML = '';
                        root.classList.remove('has-results');
                        return;
                    }

                    if (!state.isIndexLoaded) {
                        resultsList.innerHTML = '<li style="opacity:0.6; font-size:0.9em; padding:5px;">Loading search data...</li>';
                        root.classList.add('has-results');
                        loadSearchIndex();
                        return;
                    }

                    const maxSnippetsPerItem = 2;
                    const snippetWindow = 40;

                    const results = state.searchIndex.reduce((acc, item) => {
                        if (acc.length >= 10) return acc;

                        const title = item.title ? item.title.toLowerCase() : '';
                        const titleZh = item.title_zh ? item.title_zh.toLowerCase() : '';
                        const content = item.content ? item.content.toLowerCase() : '';

                        const titleMatch = title.includes(query) || titleZh.includes(query);
                        const contentMatches = [];

                        if (content && query) {
                            let matchIndex = content.indexOf(query);
                            while (matchIndex !== -1) {
                                contentMatches.push(matchIndex);
                                matchIndex = content.indexOf(query, matchIndex + query.length);
                            }
                        }

                        if (titleMatch || contentMatches.length > 0) {
                            const snippets = contentMatches.slice(0, maxSnippetsPerItem).map(index => {
                                const start = Math.max(0, index - snippetWindow);
                                const end = Math.min(content.length, index + query.length + snippetWindow);
                                let snippetText = item.content.substring(start, end);

                                const regex = new RegExp(`(${query})`, 'gi');
                                snippetText = snippetText.replace(regex, '<span class="search-match">$1</span>');

                                return `...${snippetText}...`;
                            });

                            acc.push({
                                displayTitle: isCjkQuery ? (item.title_zh || item.title) : (item.title || item.title_zh),
                                url: item.url,
                                date: item.date,
                                image: item.image,
                                snippets: snippets
                            });
                        }
                        return acc;
                    }, []);


                    if (results.length > 0) {
                        root.classList.add('has-results');
                        resultsList.innerHTML = results.map((item, index) => `
            <li data-index="${index}">
              <a href="${item.url}" style="display: flex; align-items: start; gap: 10px; text-decoration: none;">
                ${item.image ? `<img src="${item.image}" alt="" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; flex-shrink: 0; margin-top: 2px;">` : ''}
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight:bold; font-size: 0.9em; color: var(--heading-color);">${item.displayTitle}</div>
                    ${item.snippets.length > 0 ?
                                `<div class="search-snippet">${item.snippets.join('<br>')}</div>` :
                                (item.date ? `<div style="font-size:0.7em; opacity:0.7;">${item.date}</div>` : '')
                            }
                </div>
              </a>
            </li>
          `).join('');
                    } else {
                        resultsList.innerHTML = '<li style="opacity:0.6; font-size:0.9em; padding:5px;">No results found</li>';
                        root.classList.add('has-results');
                    }
                });

                input.addEventListener('keydown', function (e) {
                    const items = resultsList.querySelectorAll('li');
                    if (items.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex++;
                        if (selectedIndex >= items.length) selectedIndex = 0;
                        updateSelection();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex--;
                        if (selectedIndex < 0) selectedIndex = items.length - 1;
                        updateSelection();
                    } else if (e.key === 'Enter') {
                        if (selectedIndex > -1 && items[selectedIndex]) {
                            e.preventDefault();
                            const link = items[selectedIndex].querySelector('a');
                            if (link) {
                                closeSearch();
                                link.click();
                            }
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.style.display = 'none';
                        selectedIndex = -1;
                    }
                });
            }

            if (!document.body.dataset.navbarSearchDocBound) {
                document.body.dataset.navbarSearchDocBound = 'true';

                document.addEventListener('click', function (e) {
                    const dropdownEl = document.getElementById('navbar-search-dropdown');
                    const toggleBtnEl = document.getElementById('navbar-search-toggle');

                    if (!dropdownEl || !toggleBtnEl) return;
                    if (dropdownEl.style.display !== 'block') return;

                    if (dropdownEl.contains(e.target) || toggleBtnEl.contains(e.target)) {
                        return;
                    }

                    dropdownEl.style.display = 'none';
                });
            }
        }

        const deferredInit = function () {
            requestAnimationFrame(initNavbarSearch);
        };

        document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
        window.addEventListener('hy:pjax:end', deferredInit);

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            deferredInit();
        }
    })();

    (function () {
        const THEME_KEY = 'site_theme_mode';
        const MODE_LIGHT = 'light';
        const MODE_DARK = 'dark';
        const CLASS_LIGHT = 'light-mode';
        const CLASS_DARK = 'dark-mode';

        function safeGet(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                return null;
            }
        }

        function safeSet(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
            }
        }

        function safeRemove(key) {
            try {
                localStorage.removeItem(key);
            } catch (e) {
            }
        }

        function normalizeMode(value) {
            if (value === MODE_LIGHT || value === MODE_DARK) {
                return value;
            }
            return null;
        }

        function readBodyMode() {
            const body = document.body;
            if (!body) return null;
            if (body.classList.contains(CLASS_DARK)) return MODE_DARK;
            if (body.classList.contains(CLASS_LIGHT)) return MODE_LIGHT;
            return null;
        }

        function applyMode(mode) {
            const body = document.body;
            if (!body) return;
            body.classList.remove(CLASS_LIGHT, CLASS_DARK);
            if (mode === MODE_LIGHT) {
                body.classList.add(CLASS_LIGHT);
            } else if (mode === MODE_DARK) {
                body.classList.add(CLASS_DARK);
            }
        }

        let lastStored = null;

        function persistMode() {
            const mode = readBodyMode();
            if (mode === lastStored) return;
            lastStored = mode;
            if (mode) {
                safeSet(THEME_KEY, mode);
            } else {
                safeRemove(THEME_KEY);
            }
        }

        function initThemePreference() {
            const body = document.body;
            if (!body) return;

            const stored = normalizeMode(safeGet(THEME_KEY));
            if (stored) {
                applyMode(stored);
            }

            if (body.dataset.themeModeObserver) return;
            body.dataset.themeModeObserver = 'true';

            const observer = new MutationObserver(function (mutations) {
                for (let i = 0; i < mutations.length; i++) {
                    if (mutations[i].attributeName === 'class') {
                        persistMode();
                        break;
                    }
                }
            });

            observer.observe(body, { attributes: true, attributeFilter: ['class'] });
        }

        const deferredInit = function () {
            requestAnimationFrame(initThemePreference);
        };

        document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
        window.addEventListener('hy:pjax:end', deferredInit);

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            deferredInit();
        }
    })();

    (function () {
        const LANG_KEY = 'site_language';
        const LANG_EN = 'en';
        const LANG_ZH = 'zh';

        function safeGet(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                return null;
            }
        }

        function safeSet(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
            }
        }

        function normalizeLang(value) {
            if (value === LANG_EN || value === LANG_ZH) {
                return value;
            }
            return null;
        }

        function detectBrowserLang() {
            const languages = (navigator.languages && navigator.languages.length)
                ? navigator.languages
                : [navigator.language || navigator.userLanguage || ''];

            for (let i = 0; i < languages.length; i++) {
                const lang = (languages[i] || '').toLowerCase();
                if (lang.startsWith('zh')) {
                    return LANG_ZH;
                }
            }
            return LANG_EN;
        }

        function getPreferredLang() {
            const stored = normalizeLang(safeGet(LANG_KEY));
            if (stored) return stored;
            return detectBrowserLang();
        }

        function updateUi(lang) {
            const btn = document.getElementById('_lang-toggle');
            if (btn) {
                btn.setAttribute('title', lang === LANG_ZH ? 'Switch to English' : '切换到中文');
            }

            const searchInput = document.getElementById('navbar-search-input');
            if (searchInput) {
                searchInput.placeholder = lang === LANG_ZH ? '搜索...' : 'Search...';
            }

            if (document.documentElement) {
                document.documentElement.setAttribute('lang', lang === LANG_ZH ? 'zh' : 'en');
            }
        }

        function applyLang(lang) {
            const body = document.body;
            if (!body) return;

            const normalized = normalizeLang(lang) || LANG_EN;
            /* Update both html and body to keep them in sync */
            document.documentElement.classList.remove('lang-zh', 'lang-en');
            document.documentElement.classList.add('lang-' + normalized);
            body.classList.remove('lang-zh', 'lang-en');
            body.classList.add('lang-' + normalized);
            updateUi(normalized);
        }

        function setLang(lang) {
            const normalized = normalizeLang(lang) || LANG_EN;
            applyLang(normalized);
            safeSet(LANG_KEY, normalized);
        }

        function toggleLang() {
            const body = document.body;
            const current = body && body.classList.contains('lang-zh') ? LANG_ZH : LANG_EN;
            const next = current === LANG_ZH ? LANG_EN : LANG_ZH;
            setLang(next);
        }

        function initLangToggle() {
            const btn = document.getElementById('_lang-toggle');
            if (btn && !btn.dataset.langToggleBound) {
                btn.dataset.langToggleBound = 'true';
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleLang();
                });
            }
        }

        function initLangPreference() {
            setLang(getPreferredLang());
            initLangToggle();
        }

        /* Immediately set language class on documentElement to prevent flash of wrong language */
        (function earlyLangInit() {
            const stored = normalizeLang(safeGet(LANG_KEY));
            const lang = stored || detectBrowserLang();
            /* Apply to both html and body if available */
            document.documentElement.classList.remove('lang-zh', 'lang-en');
            document.documentElement.classList.add('lang-' + lang);
            if (document.body) {
                document.body.classList.remove('lang-zh', 'lang-en');
                document.body.classList.add('lang-' + lang);
            }
        })();

        const deferredInit = function () {
            requestAnimationFrame(initLangPreference);
        };

        document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
        window.addEventListener('hy:pjax:end', deferredInit);

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            deferredInit();
        }
    })();
</script>