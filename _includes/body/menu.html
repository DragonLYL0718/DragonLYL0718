<div id="_navbar" class="navbar fixed-top">
    <div class="content">
        <span class="sr-only">{{ site.data.strings.jump_to | default:"Jump to" }}{{ site.data.strings.colon |
            default:":" }}</span>
        <div class="nav-btn-bar">
            <a id="_menu" class="nav-btn no-hover" href="#_drawer--opened">
                <span class="sr-only">{{ site.data.strings.navigation | default:"Navigation" }}</span>
                <span class="icon-menu"></span>
            </a>

            <!-- Navbar Search Component -->
            <div id="navbar-search-component" style="display:inline-block; position:relative;">
                <button id="navbar-search-toggle" class="nav-btn no-hover" aria-label="Search">
                    <span class="icon-search"></span>
                </button>

                <div id="navbar-search-dropdown"
                    style="display:none; position:absolute; top:100%; left:0; width:300px; background:var(--body-bg); border:1px solid var(--border-color); box-shadow:0 4px 6px rgba(0,0,0,0.1); border-radius:4px; padding:10px; z-index:9999;">
                    <input type="text" id="navbar-search-input" placeholder="Search..."
                        style="width:100%; padding:8px; border:1px solid var(--border-color); border-radius:4px; background:var(--body-bg); color:var(--body-color);">
                    <ul id="navbar-search-results"
                        style="list-style:none; padding:0; margin-top:10px; max-height:300px; overflow-y:auto; margin-bottom:0;">
                    </ul>
                </div>
            </div>

            <div class="nav-span"></div>
        </div>
    </div>
</div>
<hr class="sr-only" hidden />

<style>
    #navbar-search-dropdown {
        /* Adjust positioning if needed to not go off-screen appropriately, though left:0 aligns with button */
    }

    #navbar-search-results li {
        padding: 5px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    #navbar-search-results li a {
        text-decoration: none;
        display: block;
    }

    /* Dark mode tweaks if not handled by vars */
    body.dark-mode #navbar-search-dropdown {
        background: #2a2d2f;
        border-color: #444;
    }

    body.dark-mode #navbar-search-input {
        background: #333;
        border-color: #555;
        color: #fff;
    }

    .search-result-selected {
        background-color: rgba(125, 125, 125, 0.1);
    }

    body.dark-mode .search-result-selected {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .search-snippet {
        font-size: 0.8em;
        color: var(--body-color);
        opacity: 0.8;
        margin-top: 2px;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .search-match {
        font-weight: bold;
        color: var(--heading-color);
        background: rgba(255, 255, 0, 0.2);
    }

    body.dark-mode .search-match {
        background: rgba(255, 255, 0, 0.2);
        color: #fff;
    }
</style>

<script>
    (function () {
        const state = window.NavbarSearchState || (window.NavbarSearchState = {
            searchIndex: [],
            isIndexLoaded: false,
            isIndexLoading: false
        });

        function loadSearchIndex() {
            if (state.isIndexLoaded || state.isIndexLoading) return;

            state.isIndexLoading = true;
            const searchJsonUrl = '{{ "/search.json" | relative_url }}';
            fetch(searchJsonUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    state.searchIndex = data;
                    state.isIndexLoaded = true;
                })
                .catch(err => console.error('Failed to load search index', err))
                .finally(() => {
                    state.isIndexLoading = false;
                });
        }

        function initNavbarSearch() {
            const root = document.getElementById('navbar-search-component');
            if (!root) return;

            const toggleBtn = document.getElementById('navbar-search-toggle');
            const dropdown = document.getElementById('navbar-search-dropdown');
            const input = document.getElementById('navbar-search-input');
            const resultsList = document.getElementById('navbar-search-results');

            if (!toggleBtn || !dropdown || !input || !resultsList) return;

            if (!root.dataset.navbarSearchInitialized) {
                root.dataset.navbarSearchInitialized = 'true';

                toggleBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const isHidden = dropdown.style.display === 'none' || dropdown.style.display === '';
                    dropdown.style.display = isHidden ? 'block' : 'none';

                    if (isHidden) {
                        input.focus();
                        loadSearchIndex();
                    }
                });
            }

            if (!input.dataset.navbarSearchBound) {
                input.dataset.navbarSearchBound = 'true';
                let selectedIndex = -1;

                function updateSelection() {
                    const items = resultsList.querySelectorAll('li');
                    items.forEach((item, index) => {
                        if (index === selectedIndex) {
                            item.classList.add('search-result-selected');
                            item.scrollIntoView({ block: 'nearest' });
                        } else {
                            item.classList.remove('search-result-selected');
                        }
                    });
                }

                input.addEventListener('input', function () {
                    const query = this.value.toLowerCase();
                    selectedIndex = -1;

                    if (query.length < 2) {
                        resultsList.innerHTML = '';
                        return;
                    }

                    if (!state.isIndexLoaded) {
                        resultsList.innerHTML = '<li style="opacity:0.6; font-size:0.9em; padding:5px;">Loading search data...</li>';
                        loadSearchIndex();
                        return;
                    }

                    const maxSnippetsPerItem = 2;
                    const snippetWindow = 40;

                    const results = state.searchIndex.reduce((acc, item) => {
                        if (acc.length >= 10) return acc;

                        const title = item.title ? item.title.toLowerCase() : '';
                        const content = item.content ? item.content.toLowerCase() : '';

                        const titleMatch = title.includes(query);
                        const contentMatches = [];

                        if (content && query) {
                            let matchIndex = content.indexOf(query);
                            while (matchIndex !== -1) {
                                contentMatches.push(matchIndex);
                                matchIndex = content.indexOf(query, matchIndex + query.length);
                            }
                        }

                        if (titleMatch || contentMatches.length > 0) {
                            const snippets = contentMatches.slice(0, maxSnippetsPerItem).map(index => {
                                const start = Math.max(0, index - snippetWindow);
                                const end = Math.min(content.length, index + query.length + snippetWindow);
                                let snippetText = item.content.substring(start, end);

                                const regex = new RegExp(`(${query})`, 'gi');
                                snippetText = snippetText.replace(regex, '<span class="search-match">$1</span>');

                                return `...${snippetText}...`;
                            });

                            acc.push({
                                title: item.title,
                                url: item.url,
                                date: item.date,
                                snippets: snippets
                            });
                        }
                        return acc;
                    }, []);


                    if (results.length > 0) {
                        resultsList.innerHTML = results.map((item, index) => `
            <li data-index="${index}">
              <a href="${item.url}">
                <div style="font-weight:bold; font-size: 0.9em; color: var(--heading-color);">${item.title}</div>
                ${item.snippets.length > 0 ?
                                `<div class="search-snippet">${item.snippets.join('<br>')}</div>` :
                                (item.date ? `<div style="font-size:0.7em; opacity:0.7;">${item.date}</div>` : '')
                            }
              </a>
            </li>
          `).join('');
                    } else {
                        resultsList.innerHTML = '<li style="opacity:0.6; font-size:0.9em; padding:5px;">No results found</li>';
                    }
                });

                input.addEventListener('keydown', function (e) {
                    const items = resultsList.querySelectorAll('li');
                    if (items.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        selectedIndex++;
                        if (selectedIndex >= items.length) selectedIndex = 0;
                        updateSelection();
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        selectedIndex--;
                        if (selectedIndex < 0) selectedIndex = items.length - 1;
                        updateSelection();
                    } else if (e.key === 'Enter') {
                        if (selectedIndex > -1 && items[selectedIndex]) {
                            e.preventDefault();
                            const link = items[selectedIndex].querySelector('a');
                            if (link) link.click();
                        }
                    } else if (e.key === 'Escape') {
                        dropdown.style.display = 'none';
                        selectedIndex = -1;
                    }
                });
            }

            if (!document.body.dataset.navbarSearchDocBound) {
                document.body.dataset.navbarSearchDocBound = 'true';

                document.addEventListener('click', function (e) {
                    const dropdownEl = document.getElementById('navbar-search-dropdown');
                    const toggleBtnEl = document.getElementById('navbar-search-toggle');

                    if (!dropdownEl || !toggleBtnEl) return;
                    if (dropdownEl.style.display !== 'block') return;

                    if (dropdownEl.contains(e.target) || toggleBtnEl.contains(e.target)) {
                        return;
                    }

                    dropdownEl.style.display = 'none';
                });
            }
        }

        const deferredInit = function () {
            requestAnimationFrame(initNavbarSearch);
        };

        document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
        window.addEventListener('hy:pjax:end', deferredInit);

        if (document.readyState === 'interactive' || document.readyState === 'complete') {
            deferredInit();
        }
    })();
</script>