# Project Context & Agent Guide

This repository is a Jekyll site built on the Hydejack theme. Use this guide to avoid common pitfalls when editing templates, scripts, or data files.

## 1. Technology Stack
- **Static Site Generator**: Jekyll
- **Theme**: Hydejack (`jekyll-theme-hydejack`)
- **Languages**: HTML, SCSS/CSS, JavaScript, Markdown, Liquid

## 2. Critical Implementation Constraints

### 2.1 Dynamic Page Loading (PJAX)
Hydejack uses PJAX to swap page content without a full reload. Standard events like `DOMContentLoaded` or `window.load` do not fire on internal navigation.

**Required pattern (idempotent init + PJAX hook):**
```javascript
function initMyFeature() {
  const root = document.querySelector('.my-feature');
  if (!root || root.dataset.initialized) return;
  root.dataset.initialized = 'true';
  /* setup... */
}

const deferredInit = () => requestAnimationFrame(initMyFeature);

document.addEventListener('DOMContentLoaded', deferredInit, { once: true });
window.addEventListener('hy:pjax:end', deferredInit);

if (document.readyState === 'interactive' || document.readyState === 'complete') {
  deferredInit();
}
```

### 2.2 Inline Script Comments
**Constraint:** Do not use `//` comments in inline `<script>` tags within HTML files.  
**Reason:** Hydejack minification/parsing can break inline scripts with `//`.  
**Best Practice:** Use block comments `/* ... */`.

### 2.3 Generated Output
`_site/` is generated by Jekyll. Do not edit it by hand.

### 2.4 Search Functionality
Search may be disabled in `development` to save build time. To test search locally:
```bash
JEKYLL_ENV=production bundle exec jekyll serve
```

## 3. Key Locations
- `_config.yml`: Jekyll and theme configuration.
- `_includes/` and `_layouts/`: Liquid templates and page layouts.
- `assets/`: Static assets and Hydejack JS notes (`assets/readme.md`, `assets/AGENTS.md`).
- `_sass/my-style.scss`: Custom styles, including map styles.
- `_galleries/`: Gallery data for the travel map (see `_galleries/AGENTS.md`).

## 4. Feature Documentation

### 4.1 Travel Gallery System
- **Overview**: The gallery system consists of two parts:
  1. **Map & Index Data**: Metadata for the interactive map and gallery lists.
  2. **Content Pages**: Actual photo gallery pages.

- **Part 1: Map Data**
  - **Location**: `_galleries/YYYY.md` or `_galleries/before-YYYY.md`
  - **Structure**: YAML files containing a list of `items`.
  - **Key Fields**: `lat`, `lng`, `url` (link to content page), `image` (thumbnail).
  - **Usage**: Feeds `_layouts/pagegallery.html` to generate the global map and year-based lists.
  - **Grouping**: Years > 2020 are dynamically grouped into 5-year blocks (e.g., 2026-2027). Older years are grouped under "Before 2021".

- **Part 2: Content Pages**
  - **Location**: `/travel/gallery/YYYY/CityName.md`
  - **Layout**: `pagefigure`
  - **Implementation**: Masonry grid + Lightbox + Lazy Loading.
  - **Front Matter**: `images` list (url, thumbnail, alt).

- **Implementation Details**:
  - **Page Script**: `assets/js/pagegallery.js` defines `window.GalleryPage`, runs PJAX-safe init, and only activates when `.tab-container[data-gallery-page="true"]` exists.
  - **Data Feed**: `_layouts/pagegallery.html` embeds `script#gallery-data` with `site.galleries` JSON for the map/list UI.
  - **Map**: Leaflet.js + Leaflet.markercluster
  - **Styles**: `_sass/my-style.scss` ("Map Styles" section)

### 4.2 Navbar Search
- **Overview**: Client-side search integrated into the top navigation bar.
- **Components**:
  - **Data Source**: `search.json` (root), generated by Liquid.
  - **UI Implementation**: `_includes/body/menu.html` (replaces default nav).
  - **Logic**: Inline JavaScript in `menu.html` handles fetching `search.json`, filtering, and keyboard navigation.
- **Key Features**:
  - **Expandable Input**: Toggles visibility on click.
  - **Image Previews**: Displays thumbnails for gallery pages (sourced from `site.galleries` via `search.json`).
  - **Snippets**: Shows contextual text matches with highlighting.
  - **Keyboard Nav**: Supports ArrowUp/Down and Enter.
- **Exclusions**: `search.json` logic explicitly excludes `LICENSE` and utility pages.


## 5. Development Workflow
- **Start Local Server**: `bundle exec jekyll serve`
- **Start Production Server (Locally)**: `JEKYLL_ENV=production bundle exec jekyll serve`
